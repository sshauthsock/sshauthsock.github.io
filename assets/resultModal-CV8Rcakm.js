import{b}from"./utils-CHsLvtYz.js";import{s as T}from"./index-MvYk2PFn.js";import{i as P,S as B,F as Q,P as N}from"./constants-r0ry0Tln.js";import{a as K}from"./supportMessage-C6tx5lCv.js";const V="savedOptimalCombinations",W="combinationCounter",ee=5;function R(){try{const t=localStorage.getItem(V),n=t?JSON.parse(t):{수호:[],탑승:[],변신:[]};return n.수호||(n.수호=[]),n.탑승||(n.탑승=[]),n.변신||(n.변신=[]),n}catch(t){return console.error("Failed to load history from localStorage:",t),{수호:[],탑승:[],변신:[]}}}function G(){try{const t=localStorage.getItem(W),n=t?JSON.parse(t):{수호:0,탑승:0,변신:0};return n.수호===void 0&&(n.수호=0),n.탑승===void 0&&(n.탑승=0),n.변신===void 0&&(n.변신=0),n}catch(t){return console.error("Failed to load counter from localStorage:",t),{수호:0,탑승:0,변신:0}}}function Y(t,n){try{localStorage.setItem(V,JSON.stringify(t)),localStorage.setItem(W,JSON.stringify(n))}catch(e){console.error("기록 저장 실패:",e),alert("조합 기록 저장에 실패했습니다. 저장 공간이 부족할 수 있습니다.")}}function te(t){if(!t||!t.spirits||t.spirits.length===0||!t.spirits[0].type){console.warn("Invalid result data provided to addResult:",t);return}const n=t.spirits[0].type;if(!["수호","탑승","변신"].includes(n)){console.warn(`Invalid category '${n}' for history storage.`);return}const e=R(),i=G();i[n]===void 0&&(i[n]=0);const a=new Date,o={...t,timestamp:a.toLocaleString("sv-SE"),id:a.getTime()};let d=-1;for(let r=0;r<ee;r++)if(!e[n][r]){d=r;break}d===-1&&(d=e[n].map((c,l)=>({entry:c,index:l})).filter(({entry:c})=>c!==null).reduce((c,l)=>!c||l.entry.id<c.entry.id?l:c,null)?.index||0),e[n][d]=o,i[n]++,Y(e,i)}function ne(t,n){const e=R(),i=G();if(!e[t])return console.warn(`Attempted to remove from unknown category: ${t}`),!1;const a=e[t].findIndex(o=>o&&o.id===n);return a===-1?(console.warn(`Entry with id ${n} not found in category ${t}`),!1):(e[t][a]=null,Y(e,i),!0)}function U(t){const n=R();if(!n[t])return console.warn(`Attempted to retrieve history for unknown category: ${t}`),[];const e=n[t].filter(Boolean);return e.sort((i,a)=>a.id-i.id),e}let I=null,h=null,S=null,f=[],s={isPressed:!1,intervalId:null,timeoutId:null,hintElement:null,bridgeElement:null,hintHovered:!1,button:null,spiritName:null,action:null,mouseDownTime:null};const A={damageResistance:"stat-damage-resistance",damageResistancePenetration:"stat-damage-resistance-penetration",pvpDefensePercent:"stat-pvp-defense-percent",pvpDamagePercent:"stat-pvp-damage-percent"},ie=["damageResistance","damageResistancePenetration","pvpDamagePercent","pvpDefensePercent"];function v(t){if(t==null)return 0;const n=parseFloat(String(t).replace(/,/g,""));return isNaN(n)?0:n}function O(t,n){if(!t)return{spiritName:null,stats:[],totalScore:0};const e=T.allSpirits.find(r=>r.name===t);if(!e)return{spiritName:t,stats:[],totalScore:0};const a=e.stats.find(r=>r.level===n)?.registrationStat||{};let o=0;const d=[];return Object.entries(a).forEach(([r,c])=>{const l=v(c),u=B[r]||r;r==="damageResistance"||r==="damageResistancePenetration"?o+=l:(r==="pvpDamagePercent"||r==="pvpDefensePercent")&&(o+=l*10),l>0&&d.push({key:r,name:u,value:l,isScoreContributing:ie.includes(r)})}),{spiritName:t,stats:d,totalScore:Math.round(o)}}function k(t){let n=0;const e={};return t.forEach(i=>{const a=T.allSpirits.find(o=>o.name===i.name&&o.type===i.type);if(a){const o=a.stats.find(d=>d.level===i.stats[0].level);o?.bindStat&&Object.entries(o.bindStat).forEach(([d,r])=>{const c=v(r);e[d]=(e[d]||0)+c,d==="damageResistance"||d==="damageResistancePenetration"?n+=c:(d==="pvpDamagePercent"||d==="pvpDefensePercent")&&(n+=c*10)})}}),{bindScore:n,bindStats:Object.entries(e).filter(([,i])=>i>0).map(([i,a])=>({key:i,name:B[i]||i,value:a}))}}function H(t,n,e,i,a={}){const o=document.getElementById(t);if(!o)return;let d="";a.gradeCounts?d=Object.entries(a.gradeCounts).filter(([,l])=>l>=2).map(([l,u])=>`<span class="grade-tag grade-tag-${l==="전설"?"legend":"immortal"}">${l}x${u}</span>`).join(" "):a.factionCounts&&(d=Object.entries(a.factionCounts).filter(([,l])=>l>=2).map(([l,u])=>{const p=Q[l]||"";return`<span class="faction-tag" title="${l}"><img src="${p}" class="faction-icon" alt="${l}">x${u}</span>`}).join(" "));const r=Array.isArray(e)?e:[];let c='<p class="no-effects">효과 없음</p>';r.length>0&&(c=`<ul class="effects-list">${r.map(l=>{const p=N.includes(l.key)?`${v(l.value)}%`:v(l.value).toLocaleString();return`<li class="${A[l.key]||""}"><span class="stat-name">${l.name}</span><span class="stat-value">${p}</span></li>`}).join("")}</ul>`),o.innerHTML=`
        <h4>${n} <span class="section-score">${Math.round(v(i))}</span></h4>
        ${d?`<div class="set-info">${d}</div>`:""}
        <div class="effects-content">${c}</div>
    `}function se(){M();const t=b("div","modal-overlay",{id:"optimalModal"}),n=b("div","modal-content",{id:"optimalModalContent"}),e=b("button","modal-close",{id:"closeOptimalModal",text:"✕"});n.appendChild(e),t.appendChild(n),document.body.appendChild(t),e.onclick=M,t.addEventListener("click",a=>{a.target===t&&M()});const i=a=>{a.key==="Escape"&&M()};return document.addEventListener("keydown",i),t._escListener=i,I=t,{modal:t,content:n}}function F(){const t=document.getElementById("registrationEffectSection");if(!t)return;if(!h){t.style.display="none";return}const n=f.find(d=>d.name===h),e=n?n.stats[0].level:25,i=O(h,e);if(i.stats.length===0){t.innerHTML=`
      <h4>등록 효과 <span class="section-score">0</span></h4>
      <div class="set-info">
        <span class="registration-spirit-tag">사용중: ${h}</span>
      </div>
      <div class="effects-content">
        <p class="no-effects">등록 효과가 없습니다</p>
      </div>
    `,t.style.display="block";return}const o=`<ul class="effects-list">${i.stats.map(d=>{const c=N.includes(d.key)?`${d.value}%`:d.value.toLocaleString();return`<li class="${A[d.key]||""}"><span class="stat-name">${d.name}</span><span class="stat-value">${c}</span></li>`}).join("")}</ul>`;t.innerHTML=`
    <h4>등록 효과 <span class="section-score">${i.totalScore}</span></h4>
    <div class="set-info">
      <span class="registration-spirit-tag">사용중: ${h}</span>
    </div>
    <div class="effects-content">
      ${o}
    </div>
  `,t.style.display="block"}function X(){const t=document.getElementById("hiddenRegistrationStats"),n=document.querySelector(".more-stats-button");if(t&&n)if(t.style.display==="none"){t.style.display="block";const e=t.querySelectorAll("li").length;n.textContent=`${e}개 숨기기`}else{t.style.display="none";const e=t.querySelectorAll("li").length;n.textContent=`+${e}개 더 보기`}}function C(){if(!S)return;f.forEach((g,y)=>{});const t=k(f),n=v(S.gradeScore),e=v(S.factionScore),i=Math.round(n+e+t.bindScore),a=f.find(g=>g.name===h),o=a?a.stats[0].level:25,r=O(h,o).totalScore,c=i+r;r>0?`${c.toLocaleString()}${i.toLocaleString()}`:`${i.toLocaleString()}`;let l,u;r>0?(l=`조합 합산: ${c.toLocaleString()} (${i.toLocaleString()})`,u="합산 = 등록 효과 + 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)"):(l=`조합 합산: ${i.toLocaleString()}`,u="합산 = 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)");const p=document.getElementById("optimalHeader");if(p){const g=p.querySelector(".modal-main-title");g&&(g.innerHTML=`
        ${l}
        <span class="score-formula">${u}</span>
      `)}H("optimalBindEffects","결속 효과",t.bindStats,t.bindScore),F(),Z(f),window.toggleMoreStats=X}function ae(){if(!S||!f||f.length===0){alert("저장할 조합 데이터가 없습니다.");return}const t=k(f),n=v(S.gradeScore),e=v(S.factionScore),i=f.find(l=>l.name===h),a=i?i.stats[0].level:25,d=O(h,a).totalScore,r=Math.round(n+e+t.bindScore+d),c={...S,spirits:f.map(l=>({...l,stats:[{level:l.stats[0].level}]})),bindScore:t.bindScore,bindStats:t.bindStats,gradeScore:n,factionScore:e,scoreWithBind:Math.round(n+e+t.bindScore),registrationScore:d,totalScoreWithRegistration:r,selectedUsedSpirit:h,combination:f.map(l=>l.name),timestamp:new Date().toLocaleString("sv-SE"),id:Date.now()};te(c),alert("조합이 기록에 저장되었습니다!"),setTimeout(()=>{f[0]?.type&&j(f[0].type)},100)}function oe(t,n,e){if(e.stopPropagation(),confirm("이 기록을 삭제하시겠습니까?"))if(ne(t,n)){const a=U(t);if(S&&S.id===n)if(a.length>0){const o=a[0];h=o.selectedUsedSpirit||null,S=JSON.parse(JSON.stringify(o)),f=JSON.parse(JSON.stringify(o.spirits)),q(o,!1)}else{h=null,S=null,f=[];const o=document.getElementById("optimalHeader");o&&(o.innerHTML=`
              <div class="optimal-header-left">
                <h3 class="modal-main-title">조합 합산: 저장된 기록이 없습니다</h3>
              </div>
              <div class="optimal-header-right">
                <button class="header-save-button" onclick="saveCombination()">조합 저장</button>
              </div>
            `);const d=document.getElementById("combinationResultsContainer");d&&(d.innerHTML='<p class="no-data-message">기록이 없습니다.</p>')}j(t)}else alert("기록 삭제에 실패했습니다.")}function z(t){const n=t.target;if(!n.classList.contains("level-btn"))return;const e=n.dataset.action;if(e!=="level-down"&&e!=="level-up")return;t.preventDefault(),t.stopPropagation();const i=n.dataset.spirit;i&&(s.timeoutId&&clearTimeout(s.timeoutId),s.intervalId&&clearInterval(s.intervalId),s.isPressed=!1,s.button=n,s.spiritName=i,s.action=e,s.hintHovered=!1,s.mouseDownTime=Date.now(),s.timeoutId=setTimeout(()=>{s.button===n&&ce()},300))}function le(t){t.touches[0],z({target:t.target,preventDefault:()=>t.preventDefault(),stopPropagation:()=>t.stopPropagation()})}function re(t){const n=t.changedTouches[0],e={target:document.elementFromPoint(n.clientX,n.clientY),clientX:n.clientX,clientY:n.clientY,type:"touchend"};_(e)}function ce(){if(!s.button)return;s.isPressed=!0;try{de()}catch(n){console.error("createModalHint 에러:",n)}const t=()=>{if(!s.isPressed)return!1;const n=f.findIndex(a=>a.name===s.spiritName);if(n===-1||P(s.spiritName))return!1;const e=f[n];e.stats[0].level;let i=!1;if(s.action==="level-down"&&e.stats[0].level>0?(e.stats[0].level=Math.max(0,e.stats[0].level-1),i=!0):s.action==="level-up"&&e.stats[0].level<25&&(e.stats[0].level=Math.min(25,e.stats[0].level+1),i=!0),i){const a=s.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");a&&(a.textContent=`Lv.${e.stats[0].level}`);const o=s.button.closest(".spirit-info-item-with-level").querySelector(".level-input");return o&&(o.value=e.stats[0].level),C(),!0}return!1};t(),s.intervalId=setInterval(()=>{t()||D()},200)}function D(){s.intervalId&&(clearInterval(s.intervalId),s.intervalId=null),s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=null),ue(),s.isPressed=!1,s.hintHovered=!1,s.bridgeElement=null,s.button=null,s.spiritName=null,s.action=null,s.mouseDownTime=null}function de(){if(!s.button)return;const n=(s.action==="level-down"?0:25).toString(),e=document.createElement("div");e.className="level-hint",e.textContent=n;const i=s.button.getBoundingClientRect();e.style.position="fixed",e.style.top=i.top+"px",e.style.zIndex="2100",e.style.color="white",e.style.padding="0px 4px",e.style.margin="0",e.style.border="none",e.style.borderRadius="3px",e.style.fontSize="10px",e.style.fontWeight="bold",e.style.pointerEvents="auto",e.style.cursor="pointer",e.style.whiteSpace="nowrap",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)",e.style.textAlign="center",e.style.height=i.height+"px",e.style.width="30px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.transition="all 0.2s ease",s.action==="level-down"?(e.style.left=i.left-30+"px",e.style.backgroundColor="#f44336"):(e.style.left=i.right+"px",e.style.backgroundColor="#4CAF50"),e.style.lineHeight=i.height+"px",document.body.appendChild(e),s.hintElement=e,s.hintHovered=!1;const a=document.createElement("div");a.className="hint-bridge",a.style.position="fixed",a.style.top=i.top+"px",a.style.height=i.height+"px",a.style.zIndex="2099",a.style.backgroundColor="transparent",a.style.pointerEvents="auto",s.action==="level-down"?(a.style.left=i.left-35+"px",a.style.width=35+i.width+"px"):(a.style.left=i.left+"px",a.style.width=i.width+35+"px"),document.body.appendChild(a),s.bridgeElement=a;const o=()=>{s.isPressed&&(s.hintHovered=!0,e.style.transform="scale(1.2)",e.style.fontSize="12px",e.style.fontWeight="900",e.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)")},d=()=>{s.isPressed&&(s.hintHovered=!1,e.style.transform="scale(1)",e.style.fontSize="10px",e.style.fontWeight="bold",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)")},r=()=>{if(s.isPressed&&s.hintHovered){const c=s.action==="level-down"?0:25,l=f.findIndex(u=>u.name===s.spiritName);if(l!==-1){f[l].stats[0].level=c;const u=s.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");u&&(u.textContent=`Lv.${c}`);const p=s.button.closest(".spirit-info-item-with-level").querySelector(".level-input");p&&(p.value=c),C()}D()}};e.addEventListener("mouseenter",o),e.addEventListener("mouseup",r),e.addEventListener("mouseleave",d),e.addEventListener("touchstart",c=>{c.preventDefault(),o()},{passive:!1}),e.addEventListener("touchend",c=>{c.preventDefault(),r()},{passive:!1}),a.addEventListener("touchstart",c=>{c.preventDefault(),o()},{passive:!1}),a.addEventListener("touchend",c=>{c.preventDefault()},{passive:!1})}function ue(){s.hintElement&&(document.body.removeChild(s.hintElement),s.hintElement=null),s.bridgeElement&&(document.body.removeChild(s.bridgeElement),s.bridgeElement=null)}function _(t){if(s.timeoutId&&!s.isPressed){clearTimeout(s.timeoutId);const n=f.findIndex(e=>e.name===s.spiritName);if(n!==-1){const e=f[n];e.stats[0].level,s.action==="level-down"&&e.stats[0].level>0?e.stats[0].level=Math.max(0,e.stats[0].level-1):s.action==="level-up"&&e.stats[0].level<25&&(e.stats[0].level=Math.min(25,e.stats[0].level+1));const i=s.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");i&&(i.textContent=`Lv.${e.stats[0].level}`);const a=s.button.closest(".spirit-info-item-with-level").querySelector(".level-input");a&&(a.value=e.stats[0].level),C()}s.timeoutId=null,s.button=null,s.spiritName=null,s.action=null,s.mouseDownTime=null;return}if(s.isPressed){if(t.type==="touchend"&&s.hintElement){const n=s.hintElement.getBoundingClientRect();t.clientX>=n.left&&t.clientX<=n.right&&t.clientY>=n.top&&t.clientY<=n.bottom&&(s.hintHovered=!0)}if(s.hintHovered){const n=s.action==="level-down"?0:25,e=f.findIndex(i=>i.name===s.spiritName);if(e!==-1){f[e].stats[0].level=n;const i=s.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");i&&(i.textContent=`Lv.${n}`);const a=s.button.closest(".spirit-info-item-with-level").querySelector(".level-input");a&&(a.value=n),C()}}D()}}function J(t,n){const e=t.target;if(e.classList.contains("level-btn"))return;if(e.classList.contains("level-input")){const a=e.dataset.spirit;let o=parseInt(e.value,10);(isNaN(o)||o<0)&&(o=0),o>25&&(o=25);const d=f.findIndex(r=>r.name===a);if(d!==-1){f[d].stats[0].level=o;const r=e.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");r&&(r.textContent=`Lv.${o}`),e.value=o,C()}return}const i=e.closest(".spirit-info-item-with-level");if(i&&!e.closest(".spirit-level-control")){const a=i.dataset.spiritName;h===a?h=null:h=a,document.querySelectorAll(".spirit-info-item-with-level").forEach(o=>{o.classList.remove("selected-used-spirit")}),h&&i.classList.add("selected-used-spirit"),C()}}function ge(t,n=!1){if(!t||!Array.isArray(t.combination)||t.combination.length===0){alert("계산 결과 데이터가 올바르지 않습니다.");return}const{modal:e,content:i}=se();e.style.display="flex",document.body.style.overflow="hidden",h=t.selectedUsedSpirit||null,S=JSON.parse(JSON.stringify(t)),f=JSON.parse(JSON.stringify(t.spirits)),fe(t,i,n),setTimeout(()=>{try{window.adfit&&typeof window.adfit.render=="function"?document.querySelectorAll("#optimalModalContent .kakao_ad_area").forEach(o=>{window.adfit.render(o)}):console.warn("Kakao AdFit script (window.adfit) not yet loaded or not available.")}catch(a){console.error("Kakao AdFit: Error rendering ads in modal:",a)}},100)}function fe(t,n,e){const i=b("div","optimal-header",{id:"optimalHeader"}),a=b("div","combination-results-container",{id:"combinationResultsContainer"}),o=f.map(u=>`
      <div class="spirit-info-item-with-level ${h===u.name?"selected-used-spirit":""}" data-spirit-name="${u.name}">
          <div class="spirit-image-container">
              <img src="${u.image}" alt="${u.name}">
          </div>
          <div class="spirit-info-details">
              <div class="spirit-info-name">${u.name}</div>
              <div class="spirit-info-level">Lv.${u.stats[0].level}</div>
          </div>
          ${e?"":P(u.name)?`<div class="spirit-level-control">
                    <div class="fixed-level-control">
                      <span class="fixed-level-label">25 (고정)</span>
                    </div>
                  </div>`:`<div class="spirit-level-control">
                    <button class="level-btn minus-btn" data-action="level-down" data-spirit="${u.name}">-</button>
                    <input type="number" class="level-input" min="0" max="25" value="${u.stats[0].level}" data-spirit="${u.name}">
                    <button class="level-btn plus-btn" data-action="level-up" data-spirit="${u.name}">+</button>
                  </div>`}
      </div>`).join("");a.innerHTML=`<div class="spirits-grid-container">${o}</div>`;const d=b("div","results-container");d.innerHTML=`
        <div class="results-section" id="registrationEffectSection" style="display: none;"></div>
        <div class="results-section" id="optimalGradeEffects"></div>
        <div class="results-section" id="optimalFactionEffects"></div>
        <div class="results-section" id="optimalBindEffects"></div>
    `;const r=b("div","spirit-details-container",{id:"optimalSpiritsDetails"}),c=b("div","kakao-ad-modal-container desktop-modal-ad",{});c.innerHTML=`
      <ins class="kakao_ad_area"
          data-ad-unit="DAN-avif2d68afxV6xpn"
          data-ad-width="728"
          data-ad-height="90"></ins>
  `,n.appendChild(c);const l=b("div","kakao-ad-modal-container mobile-modal-ad",{});if(l.innerHTML=`
      <ins class="kakao_ad_area"
          data-ad-unit="DAN-wnVEYOHZjycPISXg"
          data-ad-width="320"
          data-ad-height="50"></ins>
  `,n.appendChild(l),n.append(i),!e){const u=b("div","history-tabs-container",{id:"historyContainer"});n.appendChild(u)}n.append(a,d,r),K(n),setTimeout(()=>{q(t,e),e||t.spirits&&t.spirits.length>0&&t.spirits[0].type&&j(t.spirits[0].type)},10)}function q(t,n){const{gradeScore:e,factionScore:i,gradeEffects:a,factionEffects:o,spirits:d}=t,r=k(f),c=r.bindScore,l=r.bindStats,u=t.registrationScore||0,p=t.totalScoreWithRegistration||Math.round(v(e)+v(i)+v(c));u>0?`${p.toLocaleString()}${(p-u).toLocaleString()}`:`${p.toLocaleString()}`;let g,y;u>0?(g=`조합 합산: ${p.toLocaleString()} (${(p-u).toLocaleString()})`,y="합산 = 등록 효과 + 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)"):(g=`조합 합산: ${p.toLocaleString()}`,y="합산 = 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)"),document.getElementById("optimalHeader").innerHTML=`
        <div class="optimal-header-left">
          <h3 class="modal-main-title">
            ${g}
            <span class="score-formula">${y}</span>
          </h3>
        </div>
        <div class="optimal-header-right">
          ${n?"":'<button id="saveCombinationBtn" class="header-save-button">조합 저장</button>'}
        </div>
    `;const x=f.map(m=>`
      <div class="spirit-info-item-with-level ${h===m.name?"selected-used-spirit":""}" data-spirit-name="${m.name}">
          <div class="spirit-image-container">
              <img src="${m.image}" alt="${m.name}">
          </div>
          <div class="spirit-info-details">
              <div class="spirit-info-name">${m.name}</div>
              <div class="spirit-info-level">Lv.${m.stats[0].level}</div>
          </div>
          ${n?"":P(m.name)?`<div class="spirit-level-control">
                    <div class="fixed-level-control">
                      <span class="fixed-level-label">25 (고정)</span>
                    </div>
                  </div>`:`<div class="spirit-level-control">
                    <button class="level-btn minus-btn" data-action="level-down" data-spirit="${m.name}">-</button>
                    <input type="number" class="level-input" min="0" max="25" value="${m.stats[0].level}" data-spirit="${m.name}">
                    <button class="level-btn plus-btn" data-action="level-up" data-spirit="${m.name}">+</button>
                  </div>`}
      </div>`).join(""),$=document.getElementById("combinationResultsContainer");$.innerHTML=`<div class="spirits-grid-container">${x}</div>`;const w=$.querySelector(".spirits-grid-container");n||(w.addEventListener("click",m=>J(m)),w.addEventListener("input",m=>J(m)),w.addEventListener("mousedown",z),w.addEventListener("touchstart",le,{passive:!1}),document.addEventListener("mouseup",_),document.addEventListener("touchend",re));const E=document.getElementById("saveCombinationBtn");E&&!n&&(E.onclick=ae),H("optimalGradeEffects","등급 효과",a,e,{gradeCounts:d.reduce((m,L)=>(m[L.grade]=(m[L.grade]||0)+1,m),{})}),H("optimalFactionEffects","세력 효과",o,i,{factionCounts:d.reduce((m,L)=>(L.influence&&(m[L.influence]=(m[L.influence]||0)+1),m),{})}),H("optimalBindEffects","결속 효과",l,c),F(),Z(f),window.toggleMoreStats=X}function j(t){const n=U(t),e=document.getElementById("historyContainer");if(!e)return;if(n.length===0){e.innerHTML=`<p class="no-history-message">${t} 카테고리에 저장된 기록이 없습니다.</p>`;return}let i=-1,a=null;const o=n.length>0?n[0].id:null;n.forEach(r=>{const c=r.totalScoreWithRegistration||Math.round(v(r.gradeScore)+v(r.factionScore)+v(r.bindScore));c>i&&(i=c,a=r.id)});const d=Array(5).fill(null).map((r,c)=>{const l=n[c];if(!l)return'<div class="history-tab-placeholder"></div>';const u=l.totalScoreWithRegistration||Math.round(v(l.gradeScore)+v(l.factionScore)+v(l.bindScore)),p=Math.round(v(l.gradeScore)+v(l.factionScore)+v(l.bindScore)),g=l.id===o,y=l.id===a,x=l.registrationScore>0?`${u.toLocaleString()}
(${p.toLocaleString()})`:u.toLocaleString();return`<div class="history-tab ${y?"best":""} ${g?"newest active":""}" data-history-id="${l.id}">
            <div class="history-delete-btn" data-category="${t}" data-id="${l.id}" title="기록 삭제">×</div>
            <div class="tab-indicators">
                ${g?'<span class="current-marker">New</span>':""}
                ${y?'<span class="best-marker">Best</span>':""}
            </div>
            <div class="tab-main-info">
                <span class="tab-score">${x}</span>
                <span class="tab-timestamp">${l.timestamp.substring(5,16)}</span>
            </div>
        </div>`}).join("");e.innerHTML=`<div class="history-tabs">${d}</div>`,e.querySelectorAll(".history-tab").forEach(r=>{r.addEventListener("click",c=>{if(c.target.classList.contains("history-delete-btn")){const p=c.target.dataset.category,g=parseInt(c.target.dataset.id,10);oe(p,g,c);return}e.querySelectorAll(".history-tab").forEach(p=>p.classList.remove("active")),r.classList.add("active");const l=parseInt(r.dataset.historyId,10),u=n.find(p=>p.id===l);u&&(h=u.selectedUsedSpirit||null,S=JSON.parse(JSON.stringify(u)),f=JSON.parse(JSON.stringify(u.spirits)),q(u,!1))})})}function Z(t){t.forEach((o,d)=>{});const n=document.getElementById("optimalSpiritsDetails");if(!n)return;const e=new Set;if(t.forEach(o=>{const d=T.allSpirits.find(l=>l.name===o.name&&l.type===o.type);if(!d)return;const r=o.stats[0].level,c=d.stats.find(l=>l.level===r);c?.bindStat&&Object.keys(c.bindStat).forEach(l=>e.add(l))}),e.size===0){n.innerHTML="<h4>상세 스탯 비교</h4><p>선택된 환수의 장착 효과 스탯 정보가 없습니다.</p>";return}const i=[...e].sort();let a=`
        <h4>상세 스탯 비교</h4>
        <div class="table-wrapper">
            <table class="spirits-stats-table">
                <thead>
                    <tr>
                        <th>능력치</th>
                        ${t.map(o=>`<th><img src="${o.image}" class="spirit-thumbnail" alt="${o.name}" title="${o.name}"><br><span class="spirit-table-name">${o.name}</span></th>`).join("")}
                        <th class="stat-total-header">합산</th>
                    </tr>
                </thead>
                <tbody>
    `;i.forEach(o=>{const d=A[o]||"";let r=0,c="";const l=[];t.forEach(p=>{const g=T.allSpirits.find(E=>E.name===p.name&&E.type===p.type),y=p.stats[0].level,x=g?.stats.find(E=>E.level===y),$=v(x?.bindStat?.[o]);r+=$,l.push({name:p.name,level:y,value:$});const w=N.includes(o)?`${$}%`:$.toLocaleString();c+=`<td>${$>0?w:"-"}</td>`});let u;o==="pvpDamagePercent"||o==="pvpDefensePercent"?u=r>0?`${(r*10).toLocaleString()}`:"-":N.includes(o)?u=`${r.toFixed(2)}%`:u=r.toLocaleString(),a+=`
        <tr class="${d}">
            <th>${B[o]||o}</th>
            ${c}
            <td class="stat-total">${r>0?u:"-"}</td>
        </tr>`}),a+="</tbody></table></div>",n.innerHTML=a}function M(){D(),document.removeEventListener("mouseup",_),I&&(document.removeEventListener("keydown",I._escListener),I.remove(),I=null),h=null,S=null,f=[],delete window.toggleMoreStats,document.body.style.overflow="auto"}export{te as a,ge as s};
