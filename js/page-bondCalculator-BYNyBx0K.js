import{s as P,a as xe,u as z,c as we,h as ke}from"./main-CtgLAOgc.js";import{c as I,i as k,e as y,S as j,a as $e,P as q,b as Pe,d as De,r as Ne,f as Ae}from"./components-Snd72_gc.js";import{L as Oe,a as Re,l as oe,n as re,E as ce}from"./utils-Qx1knf6J.js";const pe="savedOptimalCombinations",ve="combinationCounter",qe=5;function J(){try{const n=localStorage.getItem(pe),t=n?JSON.parse(n):{수호:[],탑승:[],변신:[]};return t.수호||(t.수호=[]),t.탑승||(t.탑승=[]),t.변신||(t.변신=[]),t}catch{return{수호:[],탑승:[],변신:[]}}}function fe(){try{const n=localStorage.getItem(ve),t=n?JSON.parse(n):{수호:0,탑승:0,변신:0};return t.수호===void 0&&(t.수호=0),t.탑승===void 0&&(t.탑승=0),t.변신===void 0&&(t.변신=0),t}catch{return{수호:0,탑승:0,변신:0}}}function me(n,t){try{localStorage.setItem(pe,JSON.stringify(n)),localStorage.setItem(ve,JSON.stringify(t))}catch{alert("조합 기록 저장에 실패했습니다. 저장 공간이 부족할 수 있습니다.")}}function ge(n){if(!n||!n.spirits||n.spirits.length===0||!n.spirits[0].type)return;const t=n.spirits[0].type;if(!["수호","탑승","변신"].includes(t))return;const e=J(),l=fe();l[t]===void 0&&(l[t]=0);const i=new Date,a={...n,timestamp:i.toLocaleString("sv-SE"),id:i.getTime()};let c=-1;for(let o=0;o<qe;o++)if(!e[t][o]){c=o;break}c===-1&&(c=e[t].map((r,u)=>({entry:r,index:u})).filter(({entry:r})=>r!==null).reduce((r,u)=>!r||u.entry.id<r.entry.id?u:r,null)?.index||0),e[t][c]=a,l[t]++,me(e,l)}function Fe(n,t){const e=J(),l=fe();if(!e[n])return!1;const i=e[n].findIndex(a=>a&&a.id===t);return i===-1?!1:(e[n][i]=null,me(e,l),!0)}function he(n){const t=J();if(!t[n])return[];const e=t[n].filter(Boolean);return e.sort((l,i)=>i.id-l.id),e}let R=null,L=null,H=null,b=[],d={isPressed:!1,intervalId:null,timeoutId:null,hintElement:null,bridgeElement:null,hintHovered:!1,button:null,spiritName:null,action:null,mouseDownTime:null};const X={damageResistance:"stat-damage-resistance",damageResistancePenetration:"stat-damage-resistance-penetration",pvpDefensePercent:"stat-pvp-defense-percent",pvpDamagePercent:"stat-pvp-damage-percent"},_e=["damageResistance","damageResistancePenetration","pvpDamagePercent","pvpDefensePercent"];function G(n,t){if(!n)return{spiritName:null,stats:[],totalScore:0};const e=P.allSpirits.find(o=>o.name===n);if(!e)return{spiritName:n,stats:[],totalScore:0};const i=e.stats.find(o=>o.level===t)?.registrationStat||{};let a=0;const c=[];return Object.entries(i).forEach(([o,r])=>{const u=y(r),m=j[o]||o;o==="damageResistance"||o==="damageResistancePenetration"?a+=u:(o==="pvpDamagePercent"||o==="pvpDefensePercent")&&(a+=u*10),u>0&&c.push({key:o,name:m,value:u,isScoreContributing:_e.includes(o)})}),{spiritName:n,stats:c,totalScore:Math.round(a)}}function Z(n){let t=0;const e={};return n.forEach(l=>{const i=P.allSpirits.find(a=>a.name===l.name&&a.type===l.type);if(i){const a=i.stats.find(c=>c.level===l.stats[0].level);a?.bindStat&&Object.entries(a.bindStat).forEach(([c,o])=>{const r=y(o);e[c]=(e[c]||0)+r,c==="damageResistance"||c==="damageResistancePenetration"?t+=r:(c==="pvpDamagePercent"||c==="pvpDefensePercent")&&(t+=r*10)})}}),{bindScore:t,bindStats:Object.entries(e).filter(([,l])=>l>0).map(([l,i])=>({key:l,name:j[l]||l,value:i}))}}function U(n,t,e,l,i={}){const a=document.getElementById(n);if(!a)return;let c="";i.gradeCounts?c=Object.entries(i.gradeCounts).filter(([,g])=>g>=2).map(([g,v])=>`<span class="grade-tag grade-tag-${g==="전설"?"legend":"immortal"}">${g}x${v}</span>`).join(" "):i.factionCounts&&(c=Object.entries(i.factionCounts).filter(([,g])=>g>=2).map(([g,v])=>{const C=$e[g]||"";return`<span class="faction-tag" title="${g}"><img src="${C}" class="faction-icon" alt="${g}" loading="lazy">x${v}</span>`}).join(" "));const o=Array.isArray(e)?e:[],r=["damageResistance","damageResistancePenetration","pvpDamagePercent","pvpDefensePercent"],u=[...o].sort((g,v)=>{const C=r.includes(g.key),E=r.includes(v.key);return C&&!E?-1:!C&&E?1:C&&E?r.indexOf(g.key)-r.indexOf(v.key):(g.name||g.key).localeCompare(v.name||v.key)});let m='<p class="no-effects">효과 없음</p>';u.length>0&&(m=`<ul class="effects-list">${u.map(g=>{const v=q.includes(g.key),C=Math.round(y(g.value)),E=v?`${C}%`:C.toLocaleString();return`<li class="${X[g.key]||""}"><span class="stat-name">${g.name}</span><span class="stat-value">${E}</span></li>`}).join("")}</ul>`),a.innerHTML=`
        <h4>${t} <span class="section-score">${Math.round(y(l))}</span></h4>
        ${c?`<div class="set-info">${c}</div>`:""}
        <div class="effects-content">${m}</div>
    `}function Ve(){W();const n=I("div","modal-overlay",{id:"optimalModal"}),t=I("div","modal-content",{id:"optimalModalContent"}),e=I("button","modal-close",{id:"closeOptimalModal",text:"✕"});t.appendChild(e),n.appendChild(t),document.body.appendChild(n),e.onclick=W,n.addEventListener("click",i=>{i.target===n&&W()});const l=i=>{i.key==="Escape"&&W()};return document.addEventListener("keydown",l),n._escListener=l,R=n,{modal:n,content:t}}function be(){const n=document.getElementById("registrationEffectSection");if(!n)return;if(!L){n.style.display="none";return}const t=b.find(c=>c.name===L),e=t?t.stats[0].level:25,l=G(L,e);if(l.stats.length===0){n.innerHTML=`
      <h4>등록 효과 <span class="section-score">0</span></h4>
      <div class="set-info">
        <span class="registration-spirit-tag">사용중: ${L}</span>
      </div>
      <div class="effects-content">
        <p class="no-effects">등록 효과가 없습니다</p>
      </div>
    `,n.style.display="block";return}const a=`<ul class="effects-list">${l.stats.map(c=>{const o=q.includes(c.key),r=Math.round(y(c.value)),u=o?`${r}%`:r.toLocaleString();return`<li class="${X[c.key]||""}"><span class="stat-name">${c.name}</span><span class="stat-value">${u}</span></li>`}).join("")}</ul>`;n.innerHTML=`
    <h4>등록 효과 <span class="section-score">${l.totalScore}</span></h4>
    <div class="set-info">
      <span class="registration-spirit-tag">사용중: ${L}</span>
    </div>
    <div class="effects-content">
      ${a}
    </div>
  `,n.style.display="block"}function Se(){const n=document.getElementById("hiddenRegistrationStats"),t=document.querySelector(".more-stats-button");if(n&&t)if(n.style.display==="none"){n.style.display="block";const e=n.querySelectorAll("li").length;t.textContent=`${e}개 숨기기`}else{n.style.display="none";const e=n.querySelectorAll("li").length;t.textContent=`+${e}개 더 보기`}}function D(){if(!H)return;b.forEach((v,C)=>{});const n=Z(b),t=y(H.gradeScore),e=y(H.factionScore),l=Math.round(t+e+n.bindScore),i=b.find(v=>v.name===L),a=i?i.stats[0].level:25,o=G(L,a).totalScore,r=l+o;o>0?`${r.toLocaleString()}${l.toLocaleString()}`:`${l.toLocaleString()}`;let u,m;o>0?(u=`조합 합산: ${r.toLocaleString()} (${l.toLocaleString()})`,m="합산 = 등록 효과 + 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)"):(u=`조합 합산: ${l.toLocaleString()}`,m="합산 = 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)");const g=document.getElementById("optimalHeader");if(g){const v=g.querySelector(".modal-main-title");v&&(v.innerHTML=`
        ${u}
        <span class="score-formula">${m}</span>
      `)}U("optimalBindEffects","결속 효과",n.bindStats,n.bindScore),be(),Le(b,H.gradeEffects||[],H.factionEffects||[]),window.toggleMoreStats=Se}function We(){if(!H||!b||b.length===0){alert("저장할 조합 데이터가 없습니다.");return}const n=Z(b),t=y(H.gradeScore),e=y(H.factionScore),l=b.find(u=>u.name===L),i=l?l.stats[0].level:25,c=G(L,i).totalScore,o=Math.round(t+e+n.bindScore+c),r={...H,spirits:b.map(u=>({...u,stats:[{level:u.stats[0].level}]})),bindScore:n.bindScore,bindStats:n.bindStats,gradeScore:t,factionScore:e,scoreWithBind:Math.round(t+e+n.bindScore),registrationScore:c,totalScoreWithRegistration:o,selectedUsedSpirit:L,combination:b.map(u=>u.name),timestamp:new Date().toLocaleString("sv-SE"),id:Date.now()};ge(r),alert("조합이 기록에 저장되었습니다!"),setTimeout(()=>{b[0]?.type&&ee(b[0].type)},100)}function Ue(n,t,e){if(e.stopPropagation(),confirm("이 기록을 삭제하시겠습니까?"))if(Fe(n,t)){const i=he(n);if(H&&H.id===t)if(i.length>0){const a=i[0];L=a.selectedUsedSpirit||null,H=JSON.parse(JSON.stringify(a)),b=JSON.parse(JSON.stringify(a.spirits)),K(a,!1)}else{L=null,H=null,b=[];const a=document.getElementById("optimalHeader");a&&(a.innerHTML=`
              <div class="optimal-header-left">
                <h3 class="modal-main-title">조합 합산: 저장된 기록이 없습니다</h3>
              </div>
              <div class="optimal-header-right">
                <button class="header-save-button" onclick="saveCombination()">조합 저장</button>
              </div>
            `);const c=document.getElementById("combinationResultsContainer");c&&(c.innerHTML='<p class="no-data-message">기록이 없습니다.</p>')}ee(n)}else alert("기록 삭제에 실패했습니다.")}function ye(n){const t=n.target;if(!t.classList.contains("level-btn"))return;const e=t.dataset.action;if(e!=="level-down"&&e!=="level-up")return;n.preventDefault(),n.stopPropagation();const l=t.dataset.spirit;l&&(d.timeoutId&&clearTimeout(d.timeoutId),d.intervalId&&clearInterval(d.intervalId),d.isPressed=!1,d.button=t,d.spiritName=l,d.action=e,d.hintHovered=!1,d.mouseDownTime=Date.now(),d.timeoutId=setTimeout(()=>{d.button===t&&je()},300))}function Ye(n){n.touches[0],ye({target:n.target,preventDefault:()=>n.preventDefault(),stopPropagation:()=>n.stopPropagation()})}function ze(n){const t=n.changedTouches[0],e={target:document.elementFromPoint(t.clientX,t.clientY),clientX:t.clientX,clientY:t.clientY,type:"touchend"};Q(e)}function je(){if(!d.button)return;d.isPressed=!0;try{Je()}catch{}const n=()=>{if(!d.isPressed)return!1;const t=b.findIndex(i=>i.name===d.spiritName);if(t===-1||k(d.spiritName))return!1;const e=b[t];e.stats[0].level;let l=!1;if(d.action==="level-down"&&e.stats[0].level>0?(e.stats[0].level=Math.max(0,e.stats[0].level-1),l=!0):d.action==="level-up"&&e.stats[0].level<25&&(e.stats[0].level=Math.min(25,e.stats[0].level+1),l=!0),l){const i=d.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");i&&(i.textContent=`Lv.${e.stats[0].level}`);const a=d.button.closest(".spirit-info-item-with-level").querySelector(".level-input");return a&&(a.value=e.stats[0].level),D(),!0}return!1};n(),d.intervalId=setInterval(()=>{n()||Y()},200)}function Y(){d.intervalId&&(clearInterval(d.intervalId),d.intervalId=null),d.timeoutId&&(clearTimeout(d.timeoutId),d.timeoutId=null),Xe(),d.isPressed=!1,d.hintHovered=!1,d.bridgeElement=null,d.button=null,d.spiritName=null,d.action=null,d.mouseDownTime=null}function Je(){if(!d.button)return;const t=(d.action==="level-down"?0:25).toString(),e=document.createElement("div");e.className="level-hint",e.textContent=t;const l=d.button.getBoundingClientRect();e.style.position="fixed",e.style.top=l.top+"px",e.style.zIndex="2100",e.style.color="white",e.style.padding="0px 4px",e.style.margin="0",e.style.border="none",e.style.borderRadius="3px",e.style.fontSize="10px",e.style.fontWeight="bold",e.style.pointerEvents="auto",e.style.cursor="pointer",e.style.whiteSpace="nowrap",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)",e.style.textAlign="center",e.style.height=l.height+"px",e.style.width="30px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.transition="all 0.2s ease",d.action==="level-down"?(e.style.left=l.left-30+"px",e.style.backgroundColor="#f44336"):(e.style.left=l.right+"px",e.style.backgroundColor="#4CAF50"),e.style.lineHeight=l.height+"px",document.body.appendChild(e),d.hintElement=e,d.hintHovered=!1;const i=document.createElement("div");i.className="hint-bridge",i.style.position="fixed",i.style.top=l.top+"px",i.style.height=l.height+"px",i.style.zIndex="2099",i.style.backgroundColor="transparent",i.style.pointerEvents="auto",d.action==="level-down"?(i.style.left=l.left-35+"px",i.style.width=35+l.width+"px"):(i.style.left=l.left+"px",i.style.width=l.width+35+"px"),document.body.appendChild(i),d.bridgeElement=i;const a=()=>{d.isPressed&&(d.hintHovered=!0,e.style.transform="scale(1.2)",e.style.fontSize="12px",e.style.fontWeight="900",e.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)")},c=()=>{d.isPressed&&(d.hintHovered=!1,e.style.transform="scale(1)",e.style.fontSize="10px",e.style.fontWeight="bold",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)")},o=()=>{if(d.isPressed&&d.hintHovered){const r=d.action==="level-down"?0:25,u=b.findIndex(m=>m.name===d.spiritName);if(u!==-1){b[u].stats[0].level=r;const m=d.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");m&&(m.textContent=`Lv.${r}`);const g=d.button.closest(".spirit-info-item-with-level").querySelector(".level-input");g&&(g.value=r),D()}Y()}};e.addEventListener("mouseenter",a),e.addEventListener("mouseup",o),e.addEventListener("mouseleave",c),e.addEventListener("touchstart",r=>{r.preventDefault(),a()},{passive:!1}),e.addEventListener("touchend",r=>{r.preventDefault(),o()},{passive:!1}),i.addEventListener("touchstart",r=>{r.preventDefault(),a()},{passive:!1}),i.addEventListener("touchend",r=>{r.preventDefault()},{passive:!1})}function Xe(){d.hintElement&&(document.body.removeChild(d.hintElement),d.hintElement=null),d.bridgeElement&&(document.body.removeChild(d.bridgeElement),d.bridgeElement=null)}function Q(n){if(d.timeoutId&&!d.isPressed){clearTimeout(d.timeoutId);const t=b.findIndex(e=>e.name===d.spiritName);if(t!==-1){const e=b[t];e.stats[0].level,d.action==="level-down"&&e.stats[0].level>0?e.stats[0].level=Math.max(0,e.stats[0].level-1):d.action==="level-up"&&e.stats[0].level<25&&(e.stats[0].level=Math.min(25,e.stats[0].level+1));const l=d.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");l&&(l.textContent=`Lv.${e.stats[0].level}`);const i=d.button.closest(".spirit-info-item-with-level").querySelector(".level-input");i&&(i.value=e.stats[0].level),D()}d.timeoutId=null,d.button=null,d.spiritName=null,d.action=null,d.mouseDownTime=null;return}if(d.isPressed){if(n.type==="touchend"&&d.hintElement){const t=d.hintElement.getBoundingClientRect();n.clientX>=t.left&&n.clientX<=t.right&&n.clientY>=t.top&&n.clientY<=t.bottom&&(d.hintHovered=!0)}if(d.hintHovered){const t=d.action==="level-down"?0:25,e=b.findIndex(l=>l.name===d.spiritName);if(e!==-1){b[e].stats[0].level=t;const l=d.button.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");l&&(l.textContent=`Lv.${t}`);const i=d.button.closest(".spirit-info-item-with-level").querySelector(".level-input");i&&(i.value=t),D()}}Y()}}function de(n,t){const e=n.target;if(e.classList.contains("level-btn"))return;if(e.classList.contains("level-input")){const i=e.dataset.spirit;let a=parseInt(e.value,10);(isNaN(a)||a<0)&&(a=0),a>25&&(a=25);const c=b.findIndex(o=>o.name===i);if(c!==-1){b[c].stats[0].level=a;const o=e.closest(".spirit-info-item-with-level").querySelector(".spirit-info-level");o&&(o.textContent=`Lv.${a}`),e.value=a,D()}return}const l=e.closest(".spirit-info-item-with-level");if(l&&!e.closest(".spirit-level-control")){const i=l.dataset.spiritName;L===i?L=null:L=i,document.querySelectorAll(".spirit-info-item-with-level").forEach(a=>{a.classList.remove("selected-used-spirit")}),L&&l.classList.add("selected-used-spirit"),D()}}function Ge(n,t=!1){if(!n||!Array.isArray(n.combination)||n.combination.length===0){alert("계산 결과 데이터가 올바르지 않습니다.");return}const{modal:e,content:l}=Ve();e.style.display="flex",document.body.style.overflow="hidden",L=n.selectedUsedSpirit||null,H=JSON.parse(JSON.stringify(n)),b=JSON.parse(JSON.stringify(n.spirits)),Ze(n,l,t),setTimeout(()=>{try{window.adfit&&typeof window.adfit.render=="function"?document.querySelectorAll("#optimalModalContent .kakao_ad_area").forEach(a=>{window.adfit.render(a)}):Oe.warn("Kakao AdFit script (window.adfit) not yet loaded or not available.")}catch{}},100)}function Ze(n,t,e){const l=I("div","optimal-header",{id:"optimalHeader"}),i=I("div","combination-results-container",{id:"combinationResultsContainer"}),a=b.map(m=>`
      <div class="spirit-info-item-with-level ${L===m.name?"selected-used-spirit":""}" data-spirit-name="${m.name}">
          <div class="spirit-image-container">
              <img src="${m.image}" alt="${m.name}" loading="lazy">
          </div>
          <div class="spirit-info-details">
              <div class="spirit-info-name">${m.name}</div>
              <div class="spirit-info-level">Lv.${m.stats[0].level}</div>
          </div>
          ${e?"":k(m.name)?`<div class="spirit-level-control">
                    <div class="fixed-level-control">
                      <span class="fixed-level-label">25 (고정)</span>
                    </div>
                  </div>`:`<div class="spirit-level-control">
                    <button class="level-btn minus-btn" data-action="level-down" data-spirit="${m.name}">-</button>
                    <input type="number" class="level-input" min="0" max="25" value="${m.stats[0].level}" data-spirit="${m.name}">
                    <button class="level-btn plus-btn" data-action="level-up" data-spirit="${m.name}">+</button>
                  </div>`}
      </div>`).join("");i.innerHTML=`<div class="spirits-grid-container">${a}</div>`;const c=I("div","results-container");c.innerHTML=`
        <div class="results-section" id="registrationEffectSection" style="display: none;"></div>
        <div class="results-section" id="optimalGradeEffects"></div>
        <div class="results-section" id="optimalFactionEffects"></div>
        <div class="results-section" id="optimalBindEffects"></div>
    `;const o=I("div","spirit-details-container",{id:"optimalSpiritsDetails"}),r=I("div","kakao-ad-modal-container desktop-modal-ad",{});r.innerHTML=`
      <ins class="kakao_ad_area"
          data-ad-unit="DAN-avif2d68afxV6xpn"
          data-ad-width="728"
          data-ad-height="90"></ins>
  `,t.appendChild(r);const u=I("div","kakao-ad-modal-container mobile-modal-ad",{});if(u.innerHTML=`
      <ins class="kakao_ad_area"
          data-ad-unit="DAN-wnVEYOHZjycPISXg"
          data-ad-width="320"
          data-ad-height="50"></ins>
  `,t.appendChild(u),t.append(l),!e){const m=I("div","history-tabs-container",{id:"historyContainer"});t.appendChild(m)}t.append(i,c,o),Re(t),setTimeout(()=>{K(n,e),e||n.spirits&&n.spirits.length>0&&n.spirits[0].type&&ee(n.spirits[0].type)},10)}function K(n,t){const{gradeScore:e,factionScore:l,gradeEffects:i,factionEffects:a}=n,c=Z(b),o=c.bindScore,r=c.bindStats,u=n.registrationScore||0,m=n.totalScoreWithRegistration||Math.round(y(e)+y(l)+y(o));u>0?`${m.toLocaleString()}${(m-u).toLocaleString()}`:`${m.toLocaleString()}`;let g,v;u>0?(g=`조합 합산: ${m.toLocaleString()} (${(m-u).toLocaleString()})`,v="합산 = 등록 효과 + 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)"):(g=`조합 합산: ${m.toLocaleString()}`,v="합산 = 결속 합산 (등급 효과 + 세력 효과 + 결속 효과)<br>피해저항관통 + 피해저항 + (대인피해% × 10) + (대인방어% × 10)"),document.getElementById("optimalHeader").innerHTML=`
        <div class="optimal-header-left">
          <h3 class="modal-main-title">
            ${g}
            <span class="score-formula">${v}</span>
          </h3>
        </div>
        <div class="optimal-header-right">
          ${t?"":'<button id="saveCombinationBtn" class="header-save-button">조합 저장</button>'}
        </div>
    `;const C=b.map(S=>`
      <div class="spirit-info-item-with-level ${L===S.name?"selected-used-spirit":""}" data-spirit-name="${S.name}">
          <div class="spirit-image-container">
              <img src="${S.image}" alt="${S.name}" loading="lazy">
          </div>
          <div class="spirit-info-details">
              <div class="spirit-info-name">${S.name}</div>
              <div class="spirit-info-level">Lv.${S.stats[0].level}</div>
          </div>
          ${t?"":k(S.name)?`<div class="spirit-level-control">
                    <div class="fixed-level-control">
                      <span class="fixed-level-label">25 (고정)</span>
                    </div>
                  </div>`:`<div class="spirit-level-control">
                    <button class="level-btn minus-btn" data-action="level-down" data-spirit="${S.name}">-</button>
                    <input type="number" class="level-input" min="0" max="25" value="${S.stats[0].level}" data-spirit="${S.name}">
                    <button class="level-btn plus-btn" data-action="level-up" data-spirit="${S.name}">+</button>
                  </div>`}
      </div>`).join(""),E=document.getElementById("combinationResultsContainer");E.innerHTML=`<div class="spirits-grid-container">${C}</div>`;const x=E.querySelector(".spirits-grid-container");t||(x.addEventListener("click",S=>de(S)),x.addEventListener("input",S=>de(S)),x.addEventListener("mousedown",ye),x.addEventListener("touchstart",Ye,{passive:!1}),document.addEventListener("mouseup",Q),document.addEventListener("touchend",ze));const T=document.getElementById("saveCombinationBtn");T&&!t&&(T.onclick=We),U("optimalGradeEffects","등급 효과",i||[],e,{gradeCounts:b.reduce((S,w)=>(w.grade&&(S[w.grade]=(S[w.grade]||0)+1),S),{})}),U("optimalFactionEffects","세력 효과",a||[],l,{factionCounts:b.reduce((S,w)=>(w.influence&&(S[w.influence]=(S[w.influence]||0)+1),S),{})}),U("optimalBindEffects","결속 효과",r,o),be(),Le(b,i||[],a||[]),window.toggleMoreStats=Se}function ee(n){const t=he(n),e=document.getElementById("historyContainer");if(!e)return;if(t.length===0){e.innerHTML=`<p class="no-history-message">${n} 카테고리에 저장된 기록이 없습니다.</p>`;return}let l=-1,i=null;const a=t.length>0?t[0].id:null;t.forEach(o=>{const r=o.totalScoreWithRegistration||Math.round(y(o.gradeScore)+y(o.factionScore)+y(o.bindScore));r>l&&(l=r,i=o.id)});const c=Array(5).fill(null).map((o,r)=>{const u=t[r];if(!u)return'<div class="history-tab-placeholder"></div>';const m=u.totalScoreWithRegistration||Math.round(y(u.gradeScore)+y(u.factionScore)+y(u.bindScore)),g=Math.round(y(u.gradeScore)+y(u.factionScore)+y(u.bindScore)),v=u.id===a,C=u.id===i,E=u.registrationScore>0?`${m.toLocaleString()}
(${g.toLocaleString()})`:m.toLocaleString();return`<div class="history-tab ${C?"best":""} ${v?"newest active":""}" data-history-id="${u.id}">
            <div class="history-delete-btn" data-category="${n}" data-id="${u.id}" title="기록 삭제">×</div>
            <div class="tab-indicators">
                ${v?'<span class="current-marker">New</span>':""}
                ${C?'<span class="best-marker">Best</span>':""}
            </div>
            <div class="tab-main-info">
                <span class="tab-score">${E}</span>
                <span class="tab-timestamp">${u.timestamp.substring(5,16)}</span>
            </div>
        </div>`}).join("");e.innerHTML=`<div class="history-tabs">${c}</div>`,e.querySelectorAll(".history-tab").forEach(o=>{o.addEventListener("click",r=>{if(r.target.classList.contains("history-delete-btn")){const g=r.target.dataset.category,v=parseInt(r.target.dataset.id,10);Ue(g,v,r);return}e.querySelectorAll(".history-tab").forEach(g=>g.classList.remove("active")),o.classList.add("active");const u=parseInt(o.dataset.historyId,10),m=t.find(g=>g.id===u);m&&(L=m.selectedUsedSpirit||null,H=JSON.parse(JSON.stringify(m)),b=JSON.parse(JSON.stringify(m.spirits)),K(m,!1))})})}function Le(n,t=[],e=[]){const l=document.getElementById("optimalSpiritsDetails");if(!l)return;const i=new Set;if(n.forEach(v=>{const C=P.allSpirits.find(T=>T.name===v.name&&T.type===v.type);if(!C)return;const E=v.stats[0].level,x=C.stats.find(T=>T.level===E);x?.bindStat&&Object.keys(x.bindStat).forEach(T=>i.add(T))}),t.forEach(v=>{v.key&&i.add(v.key)}),e.forEach(v=>{v.key&&i.add(v.key)}),i.size===0){l.innerHTML="<h4>상세 스탯 비교</h4><p>선택된 환수의 장착 효과 스탯 정보가 없습니다.</p>";return}const a=["damageResistance","damageResistancePenetration","pvpDamagePercent","pvpDefensePercent"],c=[...i],o=c.filter(v=>a.includes(v)),r=c.filter(v=>!a.includes(v)).sort(),m=[...a.filter(v=>o.includes(v)),...r];let g=`
        <h4>상세 스탯 비교</h4>
        <div class="table-wrapper">
            <table class="spirits-stats-table">
                <thead>
                    <tr>
                        <th>능력치</th>
                        ${n.map(v=>`<th><img src="${v.image}" class="spirit-thumbnail" alt="${v.name}" title="${v.name}" loading="lazy"><br><span class="spirit-table-name">${v.name}</span></th>`).join("")}
                        <th class="stat-total-header">결속 합산</th>
                        <th class="stat-total-header">총 합산</th>
                    </tr>
                </thead>
                <tbody>
    `;m.forEach(v=>{const C=X[v]||"";let E=0,x=0,T=0,S="";const w=[];n.forEach($=>{const Me=P.allSpirits.find(V=>V.name===$.name&&V.type===$.type),ae=$.stats[0].level,Ie=Me?.stats.find(V=>V.level===ae),O=y(Ie?.bindStat?.[v]||0);E+=O,w.push({name:$.name,level:ae,value:O});const Te=q.includes(v)?`${Math.round(O)}%`:Math.round(O).toLocaleString();S+=`<td>${O>0?Te:"-"}</td>`});const le=t.find($=>$.key===v);le&&(x=y(le.value||0));const se=e.find($=>$.key===v);se&&(T=y(se.value||0));const A=E+x+T;let F;v==="pvpDamagePercent"||v==="pvpDefensePercent"?F=E>0?`${Math.round(E*10).toLocaleString()}`:"-":q.includes(v)?F=`${Math.round(E)}%`:F=Math.round(E).toLocaleString();let _;v==="pvpDamagePercent"||v==="pvpDefensePercent"?_=A>0?`${Math.round(A*10).toLocaleString()}`:"-":q.includes(v)?_=`${Math.round(A)}%`:_=Math.round(A).toLocaleString(),g+=`
        <tr class="${C}">
            <th>${j[v]||v}</th>
            ${S}
            <td class="stat-total stat-bind-total">${E>0?F:"-"}</td>
            <td class="stat-total stat-total-sum">${A>0?_:"-"}</td>
        </tr>`}),g+="</tbody></table></div>",l.innerHTML=g}function W(){Y(),document.removeEventListener("mouseup",Q),R&&(document.removeEventListener("keydown",R._escListener),R.remove(),R=null),L=null,H=null,b=[],delete window.toggleMoreStats,document.body.style.overflow="auto"}let s={isPressed:!1,intervalId:null,timeoutId:null,hintElement:null,bridgeElement:null,hintHovered:!1,button:null,spiritName:null,action:null,mouseDownTime:null,touchStartTime:null,touchMoveHandler:null,ignoreMouseUp:!1};const f={currentCategory:"수호",selectedSpirits:new Map,groupByInfluence:!1,currentStatFilter:""},h={},p={};function Qe(){return`
    <div class="sub-tabs" id="bondCategoryTabs">
        <div class="tab active" data-category="수호">수호</div>
        <div class="tab" data-category="탑승">탑승</div>
        <div class="tab" data-category="변신">변신</div>
    </div>

    <div class="view-toggle-container">
        <label class="toggle-switch">
            <input type="checkbox" id="influenceToggle">
            <span class="slider round"></span>
        </label>
        <span class="toggle-label">세력별 보기</span>
        <div class="stat-filter-container"></div>
        <a href="https://open.kakao.com/o/sUSXtUYe" target="_blank" class="kakao-gift-btn">
            <img src="assets/img/gift.png" alt="카카오 선물하기 아이콘" loading="lazy"
                style="height: 20px; vertical-align: middle; margin-right: 5px;">
            개발자에게 카톡 선물하기
        </a>
    </div>
    <div class="bond-container">
        <div class="main-content">
            <div class="left-panel">
                <div class="section-header">
                    <h2 class="section-title">전체 환수 목록</h2>
                    <div class="selection-controls">
                        <button id="selectAllBtn" class="btn btn-sm btn-primary">전체선택</button>
                        <button id="clearAllSelectionBtn" class="btn btn-sm btn-danger">전체해제</button>
                    </div>
                </div>
                <div id="spiritListContainer" class="spirit-selection"></div>
            </div>
            <div class="right-panel">
                <div class="selected-spirits-container">
                    <div class="selected-spirits-header">
                        <h3 class="selection-title">선택된 환수 (<span id="selectedCount">0</span>)</h3>
                    </div>
                    <div id="selectedSpiritsList" class="selected-spirits"></div>
                    <div class="header-controls">
                        <div class="level-batch-control">
                            <label>일괄 레벨:</label>
                            <input type="number" id="batchLevelInput" min="0" max="25" value="0">
                            <button id="applyBatchLevelBtn" class="btn btn-sm btn-primary">적용</button>
                        </div>
                        <div class="calculate-btn-small">
                            <button id="findOptimalBtn" class="btn btn-warning">최적 조합 찾기</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>`}function B(){te(),Ke(),M()}function te(){let n=ne();f.currentStatFilter&&(n=n.filter(t=>De(t,f.currentStatFilter))),Ne({container:h.spiritListContainer,spirits:n,onSpiritClick:ot,getSpiritState:t=>{const{hasFullRegistration:e,hasFullBind:l,hasLevel25Bind:i}=Ae(t);return{selected:f.selectedSpirits.has(t.name),registrationCompleted:e,bondCompleted:l,level25BindAvailable:i}},groupByInfluence:f.groupByInfluence})}function ne(){const n=l=>l?parseInt(l.match(/\d+/)?.[0]||"999",10):999,e=(Array.isArray(P.allSpirits)?P.allSpirits:[]).filter(l=>l.type===f.currentCategory);return e.sort((l,i)=>{const a={전설:1,불멸:2},c=a[l.grade]||99,o=a[i.grade]||99;return c!==o?c-o:n(l.image)-n(i.image)}),e}function Ke(){const n=h.selectedSpiritsList;n.innerHTML="";const t=[...f.selectedSpirits.values()].filter(i=>i.type===f.currentCategory);h.selectedCount.textContent=t.length;const e=document.getElementById("mobileSelectedCount");e&&(e.textContent=t.length);const l=document.getElementById("selectedSpiritsMobile");if(l&&(l.innerHTML=""),t.length===0){n.innerHTML="<p class='text-center text-sm text-light mt-lg'>선택된 환수가 없습니다.</p>",l&&(l.innerHTML="<p class='text-center text-sm text-light mt-lg'>선택된 환수가 없습니다.</p>");return}t.forEach(i=>{const a=I("div","selected-spirit-card");a.dataset.spiritName=i.name,a.innerHTML=`
        <button class="remove-spirit" data-action="remove" title="선택 해제">×</button>
        <div class="selected-spirit-header">
            <img src="${i.image}" alt="${i.name}" loading="lazy">
            <div class="spirit-info">
                <div class="spirit-name">${i.name}</div>
            </div>
        </div>
        <div class="spirit-level-control">
            ${k(i.name)?`<div class="fixed-level-control">
                <span class="fixed-level-label">25 (고정)</span>
              </div>`:`<button class="level-btn minus-btn" data-action="level-down">-</button>
              <input type="number" class="level-input" min="0" max="25" value="${i.level}">
              <button class="level-btn plus-btn" data-action="level-up">+</button>`}
        </div>
        `,n.appendChild(a);const c=a.querySelector(".remove-spirit");if(c&&(c.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),f.selectedSpirits.has(i.name)&&(f.selectedSpirits.delete(i.name),M(),B())}),c.addEventListener("touchend",o=>{o.preventDefault(),o.stopPropagation(),f.selectedSpirits.has(i.name)&&(f.selectedSpirits.delete(i.name),M(),B())})),l){const o=I("div","selected-spirit-card");o.dataset.spiritName=i.name,o.innerHTML=a.innerHTML,l.appendChild(o);const r=o.querySelector(".remove-spirit");r&&(r.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),f.selectedSpirits.has(i.name)&&(f.selectedSpirits.delete(i.name),M(),B())}),r.addEventListener("touchend",u=>{u.preventDefault(),u.stopPropagation(),f.selectedSpirits.has(i.name)&&(f.selectedSpirits.delete(i.name),M(),B())}))}})}function M(){localStorage.setItem("bondCalculatorState",JSON.stringify({category:f.currentCategory,spirits:[...f.selectedSpirits.values()],groupByInfluence:f.groupByInfluence,currentStatFilter:f.currentStatFilter}))}function et(){const n=localStorage.getItem("bondCalculatorState");if(n)try{const t=JSON.parse(n);f.currentCategory=t.category||"수호",f.selectedSpirits=new Map((t.spirits||[]).map(e=>[e.name,e])),f.groupByInfluence=t.groupByInfluence||!1,f.currentStatFilter=t.currentStatFilter||""}catch{f.selectedSpirits=new Map,f.groupByInfluence=!1,f.currentStatFilter=""}}function tt(){const n=h.container.querySelector(".stat-filter-container"),t=Array.isArray(P.allSpirits)?P.allSpirits:[];Pe(n,t,i=>{f.currentStatFilter=i,te()});const e=h.container.querySelector("#statFilter"),l=h.container.querySelector(".clear-filter-btn");e&&(e.value=f.currentStatFilter),l&&(l.style.display=f.currentStatFilter?"inline-flex":"none")}function nt(){const n=document.getElementById("panelToggleContainer"),t=n?n.querySelector(".right-panel"):null;t&&(t.classList.toggle("collapsed"),n.querySelector(".toggle-icon").textContent=t.classList.contains("collapsed")?"▲":"▼")}function it(){ie("mobileBatchLevel")}function lt(){Lt("mobileBatchLevel")}function st(){Be()}function at(){p.containerClickHandler=rt,h.container.addEventListener("click",p.containerClickHandler),p.containerMouseDownHandler=Ee,p.globalMouseUpHandler=Ce,p.containerTouchStartHandler=ct,p.containerTouchEndHandler=dt,p.globalTouchEndHandler=pt,h.container.addEventListener("mousedown",p.containerMouseDownHandler),h.container.addEventListener("touchstart",p.containerTouchStartHandler,{passive:!1}),h.container.addEventListener("touchend",p.containerTouchEndHandler,{passive:!1}),document.addEventListener("mouseup",p.globalMouseUpHandler),document.addEventListener("touchend",p.globalTouchEndHandler,{passive:!1}),h.container.addEventListener("mouseleave",vt),p.bondCategoryTabsClickHandler=a=>{const o=a.target.closest(".tab");o&&!o.classList.contains("active")&&(h.bondCategoryTabs.querySelector(".tab.active")?.classList.remove("active"),o.classList.add("active"),f.currentCategory=o.dataset.category,B())},h.bondCategoryTabs.addEventListener("click",p.bondCategoryTabsClickHandler),p.influenceToggleChangeHandler=bt,h.influenceToggle.addEventListener("change",p.influenceToggleChangeHandler),p.selectedSpiritsListInputHandler=ue,h.selectedSpiritsList.addEventListener("input",p.selectedSpiritsListInputHandler),p.selectAllClickHandler=yt,h.selectAllBtn.addEventListener("click",p.selectAllClickHandler),p.clearAllSelectionClickHandler=St,h.clearAllSelectionBtn.addEventListener("click",p.clearAllSelectionClickHandler),p.applyBatchLevelClickHandler=()=>ie("batchLevelInput"),h.applyBatchLevelBtn.addEventListener("click",p.applyBatchLevelClickHandler),p.findOptimalClickHandler=Be,h.findOptimalBtn.addEventListener("click",p.findOptimalClickHandler);const n=document.getElementById("panelToggleBtn"),t=document.getElementById("selectedSpiritsMobile"),e=document.getElementById("applyMobileBatchLevelBtn"),l=document.getElementById("setMaxMobileBatchLevelBtn"),i=document.getElementById("findOptimalMobileBtn");n&&(p.panelToggleBtnClickHandler=nt,n.addEventListener("click",p.panelToggleBtnClickHandler)),t&&(p.mobileSelectedSpiritsListInputHandler=ue,t.addEventListener("input",p.mobileSelectedSpiritsListInputHandler),t.addEventListener("touchstart",p.containerTouchStartHandler,{passive:!1}),t.addEventListener("mousedown",p.containerMouseDownHandler)),e&&(p.applyMobileBatchLevelClickHandler=it,e.addEventListener("click",p.applyMobileBatchLevelClickHandler)),l&&(p.setMaxMobileBatchLevelClickHandler=lt,l.addEventListener("click",p.setMaxMobileBatchLevelClickHandler)),i&&(p.findOptimalMobileClickHandler=st,i.addEventListener("click",p.findOptimalMobileClickHandler))}function ot(n){if(!n)return;const t=n.name;if(f.selectedSpirits.has(t))f.selectedSpirits.delete(t);else{const e=k(t)?25:0;f.selectedSpirits.set(t,{...n,level:e})}B()}function rt(n){const t=n.target,e=t.closest(".remove-spirit");if(e){n.preventDefault(),n.stopPropagation();const i=e.closest(".selected-spirit-card");if(i){const a=i.dataset.spiritName;a&&f.selectedSpirits.has(a)&&(f.selectedSpirits.delete(a),M(),B())}s.mouseDownTime=null;return}if(s.isPressed)return;const l=t.closest(".selected-spirit-card");if(l){const i=l.dataset.spiritName,a=f.selectedSpirits.get(i);if(!a)return;const c=t.closest("[data-action]"),o=c?c.dataset.action:null;let r=!1;switch(o){case"remove":f.selectedSpirits.delete(i),r=!0;break;case"level-down":if(k(i))break;a.level>0&&(a.level=Math.max(0,a.level-1),r=!0);break;case"level-up":if(k(i))break;a.level<25&&(a.level=Math.min(25,a.level+1),r=!0);break}r&&(M(),B())}s.mouseDownTime=null}function Ee(n){const t=n.target,e=t.closest(".selected-spirit-card");if(!e||t.closest(".remove-spirit"))return;const i=t.dataset.action;if(i!=="level-down"&&i!=="level-up")return;n.preventDefault(),n.stopPropagation();const a=e.dataset.spiritName;f.selectedSpirits.get(a)&&(s.timeoutId&&clearTimeout(s.timeoutId),s.intervalId&&clearInterval(s.intervalId),s.isPressed=!1,s.button=t,s.spiritName=a,s.action=i,s.hintHovered=!1,s.mouseDownTime=Date.now(),s.timeoutId=setTimeout(()=>{s.button===t&&mt()},300))}function ct(n){const t=n.target;if(!t.closest(".selected-spirit-card")||t.closest(".remove-spirit"))return;const i=t.classList.contains("level-btn")||t.classList.contains("minus-btn")||t.classList.contains("plus-btn"),a=t.dataset.action;if(!i||a!=="level-down"&&a!=="level-up")return;n.preventDefault(),n.stopPropagation(),s.touchStartTime=Date.now();const c={target:n.target,preventDefault:()=>{},stopPropagation:()=>{}};Ee(c)}function dt(n){if(s.isPressed){const t=n.changedTouches[0];if(s.hintElement){const e=s.hintElement.getBoundingClientRect();if(t.clientX>=e.left&&t.clientX<=e.right&&t.clientY>=e.top&&t.clientY<=e.bottom){s.hintHovered=!0;const i=s.action==="level-down"?0:25,a=f.selectedSpirits.get(s.spiritName);a&&(a.level=i,M(),B())}}N(),n.preventDefault(),n.stopPropagation()}}function ut(n){if(!s.isPressed)return;const t=n.touches[0],e=document.elementFromPoint(t.clientX,t.clientY),l=s.hintElement,i=s.bridgeElement;if(!l)return;const a=e===l||l.contains(e),c=e===i;a?s.hintHovered||(s.hintHovered=!0,l.style.transform="scale(1.2)",l.style.fontSize="12px",l.style.fontWeight="900",l.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)"):s.hintHovered&&!c&&(s.hintHovered=!1,l.style.transform="scale(1)",l.style.fontSize="10px",l.style.fontWeight="bold",l.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)")}function pt(n){if(!s.isPressed&&!s.timeoutId)return;const t=n.changedTouches[0],e=s.touchStartTime?Date.now()-s.touchStartTime:0;if(e>0&&e<300&&!s.isPressed){s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=null);const i=s.spiritName,a=s.action,c=f.selectedSpirits.get(i);if(c&&a&&!k(i)){let o=!1;a==="level-down"&&c.level>0?(c.level=Math.max(0,c.level-1),o=!0):a==="level-up"&&c.level<25&&(c.level=Math.min(25,c.level+1),o=!0),o&&(M(),B())}s.button=null,s.spiritName=null,s.action=null,s.touchStartTime=null;return}if(s.isPressed){if(s.hintElement){const i=s.hintElement.getBoundingClientRect();if(t.clientX>=i.left&&t.clientX<=i.right&&t.clientY>=i.top&&t.clientY<=i.bottom){s.hintHovered=!0;const c=s.action==="level-down"?0:25,o=f.selectedSpirits.get(s.spiritName);o&&(o.level=c,M(),B())}}N(),s.touchMoveHandler&&(document.removeEventListener("touchmove",s.touchMoveHandler),s.touchMoveHandler=null),s.touchStartTime=null;return}if(s.timeoutId){const i={target:document.elementFromPoint(t.clientX,t.clientY),clientX:t.clientX,clientY:t.clientY,type:"touchend"};Ce(i)}s.touchMoveHandler&&(document.removeEventListener("touchmove",s.touchMoveHandler),s.touchMoveHandler=null),s.touchStartTime=null}function Ce(n){if(!s.ignoreMouseUp){if(s.timeoutId&&!s.isPressed){clearTimeout(s.timeoutId),s.timeoutId=null,s.button=null,s.spiritName=null,s.action=null;return}if(s.isPressed){if(n.type==="touchend"&&s.hintElement){const t=s.hintElement.getBoundingClientRect();n.clientX>=t.left&&n.clientX<=t.right&&n.clientY>=t.top&&n.clientY<=t.bottom&&(s.hintHovered=!0)}if(s.hintHovered){const t=s.action==="level-down"?0:25,e=f.selectedSpirits.get(s.spiritName);e&&(e.level=t,M(),B())}N()}}}function vt(n){if(s.isPressed){const t=n.relatedTarget===s.hintElement||s.hintElement?.contains(n.relatedTarget),e=n.relatedTarget===s.bridgeElement||s.bridgeElement?.contains(n.relatedTarget);if(t||e)return;N()}}function ft(n,t){const e=h.selectedSpiritsList.querySelector(`[data-spirit-name="${n}"]`);if(e){const i=e.querySelector(".level-input");i&&(i.value=t,i.setAttribute("value",t),i.dispatchEvent(new Event("input",{bubbles:!0})))}const l=document.getElementById("selectedSpiritsMobile");if(l){const i=l.querySelector(`[data-spirit-name="${n}"]`);if(i){const a=i.querySelector(".level-input");a&&(a.value=t,a.setAttribute("value",t),a.dispatchEvent(new Event("input",{bubbles:!0})))}}}function mt(){if(!s.button)return;s.isPressed=!0,s.ignoreMouseUp=!0,setTimeout(()=>{s.ignoreMouseUp=!1},100);try{gt()}catch{}const n=()=>{if(!s.isPressed)return!1;const t=f.selectedSpirits.get(s.spiritName);if(!t||k(s.spiritName))return!1;t.level;let e=!1;return s.action==="level-down"&&t.level>0?(t.level=Math.max(0,t.level-1),e=!0):s.action==="level-up"&&t.level<25&&(t.level=Math.min(25,t.level+1),e=!0),e?(M(),ft(s.spiritName,t.level),!0):!1};n(),s.intervalId=setInterval(()=>{n()||N()},200)}function N(){s.intervalId&&(clearInterval(s.intervalId),s.intervalId=null),s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=null),ht(),s.touchMoveHandler&&(document.removeEventListener("touchmove",s.touchMoveHandler),s.touchMoveHandler=null),s.isPressed=!1,s.hintHovered=!1,s.bridgeElement=null,s.button=null,s.spiritName=null,s.action=null,s.mouseDownTime=null,s.touchStartTime=null,s.ignoreMouseUp=!1}function gt(){if(!s.button)return;const t=(s.action==="level-down"?0:25).toString(),e=document.createElement("div");e.className="level-hint",e.textContent=t;const l=s.button.getBoundingClientRect();e.style.position="fixed",e.style.top=l.top+"px",e.style.zIndex="1000",e.style.color="white",e.style.padding="0px 4px",e.style.margin="0",e.style.border="none",e.style.borderRadius="3px",e.style.fontSize="10px",e.style.fontWeight="bold",e.style.pointerEvents="none",e.style.cursor="pointer",e.style.whiteSpace="nowrap",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)",e.style.textAlign="center",e.style.height=l.height+"px",e.style.lineHeight=l.height+"px",e.style.width="32px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.transition="all 0.2s ease",s.action==="level-down"?(e.style.left=l.left-36+"px",e.style.backgroundColor="#f44336"):(e.style.left=l.right+4+"px",e.style.backgroundColor="#4CAF50"),document.body.appendChild(e),s.hintElement=e,s.hintHovered=!1;const i=document.createElement("div");i.className="hint-bridge",i.style.position="fixed",i.style.top=l.top+"px",i.style.height=l.height+"px",i.style.zIndex="999",i.style.backgroundColor="transparent",i.style.pointerEvents="none",s.action==="level-down"?(i.style.left=l.left-36+"px",i.style.width=36+l.width+4+"px"):(i.style.left=l.left+"px",i.style.width=l.width+4+32+"px"),document.body.appendChild(i),s.bridgeElement=i;const a=()=>{s.isPressed&&(s.hintHovered=!0,e.style.transform="scale(1.2)",e.style.fontSize="12px",e.style.fontWeight="900",e.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)")},c=()=>{s.isPressed&&(s.hintHovered=!1,e.style.transform="scale(1)",e.style.fontSize="10px",e.style.fontWeight="bold",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)")},o=()=>{if(s.isPressed){if(s.hintHovered){const r=s.action==="level-down"?0:25,u=f.selectedSpirits.get(s.spiritName);u&&(u.level=r,M(),B())}N()}};e.addEventListener("mouseenter",a),e.addEventListener("mouseup",o),e.addEventListener("mouseleave",r=>{!i.contains(r.relatedTarget)&&r.relatedTarget!==i&&c()}),e.addEventListener("touchstart",r=>{r.preventDefault(),r.stopPropagation(),a()},{passive:!1}),e.addEventListener("touchend",r=>{r.preventDefault(),r.stopPropagation(),o()},{passive:!1}),s.touchMoveHandler=ut,document.addEventListener("touchmove",s.touchMoveHandler),i.addEventListener("mouseleave",r=>{!e.contains(r.relatedTarget)&&r.relatedTarget!==e&&c()}),i.addEventListener("touchstart",r=>{r.preventDefault(),r.stopPropagation(),a()},{passive:!1}),i.addEventListener("touchend",r=>{r.preventDefault(),r.stopPropagation()},{passive:!1}),setTimeout(()=>{e&&s.isPressed&&(e.style.pointerEvents="auto"),i&&s.isPressed&&(i.style.pointerEvents="auto")},0)}function ht(){s.hintElement&&(s.hintElement.remove(),s.hintElement=null),s.bridgeElement&&(s.bridgeElement.remove(),s.bridgeElement=null)}function bt(n){f.groupByInfluence=n.target.checked,M(),te()}function ue(n){if(n.target.matches(".level-input")){const t=n.target.closest(".selected-spirit-card"),e=f.selectedSpirits.get(t.dataset.spiritName);if(e){if(k(t.dataset.spiritName)){n.target.value=25;return}let l=parseInt(n.target.value,10);(isNaN(l)||l<0)&&(l=0),l>25&&(l=25),e.level=l,n.target.value=l,M()}}}function St(){ne().forEach(t=>{f.selectedSpirits.has(t.name)&&f.selectedSpirits.delete(t.name)}),B()}function yt(){ne().forEach(t=>{f.selectedSpirits.has(t.name)||f.selectedSpirits.set(t.name,{...t,level:0})}),B()}function ie(n){const t=document.getElementById(n),e=parseInt(t.value,10);if(isNaN(e)||e<0||e>25){alert("0에서 25 사이의 레벨을 입력해주세요.");return}f.selectedSpirits.forEach(l=>{l.type===f.currentCategory&&(l.level=e)}),B()}function Lt(n){const t=document.getElementById(n);t&&(t.value=25,ie(n))}async function Be(){const n=[...f.selectedSpirits.values()].filter(o=>o.type===f.currentCategory).map(o=>({name:o.name,level:o.level}));if(n.length===0){alert("현재 탭에서 선택된 환수가 없습니다.");return}oe("calculate_optimal","Bond Calculator",{num_creatures:n.length,category:f.currentCategory});const t=document.getElementById("app-container"),e=performance.now(),l=n.length;let i="";l>6?i="최적 조합 탐색 중...":i="조합 계산 중...",xe(t,"최적 조합 계산 중",i,0,"초기화 중...");let a=0;const c=setInterval(()=>{a<90&&(a+=Math.random()*10,l>6?z(a,`조합 탐색 중... ${Math.round(a)}%`):z(a,`계산 중... ${Math.round(a)}%`))},500);try{const o=await we(n);clearInterval(c),z(100,"완료!"),await new Promise(u=>setTimeout(u,300));const r=performance.now()-e;if(re("bond",r,{num_creatures:l,score:o?.scoreWithBind||0}),!o||!o.spirits)throw new Error("API에서 유효한 응답을 받지 못했습니다.");ge(o),Ge(o,!1),oe("open_result_modal","Bond Calculator")}catch(o){clearInterval(c);const r=performance.now()-e;re("bond",r,{num_creatures:l,success:!1}),ce.handle(o,"Optimal combination calculation"),alert(ce.getUserFriendlyMessage(o.message))}finally{ke()}}function Et(n){He(),n.innerHTML=Qe();const t=`
    <button class="panel-toggle-button" id="panelToggleBtn">
        선택된 환수 <span id="mobileSelectedCount">0</span>개 <span class="toggle-icon">▲</span>
    </button>
    <div class="right-panel collapsed">
        <div class="selected-spirits-container">
            <div class="selected-spirits-header">
                <h3>선택된 환수</h3>
                <div class="header-controls">
                    <div class="level-batch-control">
                        <label>일괄 레벨 설정:</label>
                        <input type="number" id="mobileBatchLevel" min="0" max="25" value="0">
                        <button id="applyMobileBatchLevelBtn" class="btn btn-primary apply-level-btn">적용</button>
                        <button id="setMaxMobileBatchLevelBtn" class="btn btn-warning max-level-btn">Max</button>
                    </div>
                    <div class="calculate-btn-small">
                        <button id="findOptimalMobileBtn" class="btn btn-secondary">찾기</button>
                    </div>
                </div>
            </div>
            <div id="selectedSpiritsMobile" class="selected-spirits"></div>
        </div>
    </div>`,e=I("div","panel-toggle-container",{id:"panelToggleContainer"});e.innerHTML=t,document.body.appendChild(e);const l=h;l.container=n,l.bondCategoryTabs=n.querySelector("#bondCategoryTabs"),l.spiritListContainer=n.querySelector("#spiritListContainer"),l.selectedSpiritsList=n.querySelector("#selectedSpiritsList"),l.selectedCount=n.querySelector("#selectedCount"),l.selectAllBtn=n.querySelector("#selectAllBtn"),l.clearAllSelectionBtn=n.querySelector("#clearAllSelectionBtn"),l.batchLevelInput=n.querySelector("#batchLevelInput"),l.applyBatchLevelBtn=n.querySelector("#applyBatchLevelBtn"),l.findOptimalBtn=n.querySelector("#findOptimalBtn"),l.influenceToggle=n.querySelector("#influenceToggle"),et(),n.querySelectorAll(".sub-tabs .tab").forEach(i=>{i.classList.toggle("active",i.dataset.category===f.currentCategory)}),h.influenceToggle.checked=f.groupByInfluence,at(),tt(),B()}function Ct(){return`
        <div class="content-block">
            <h2>환수 결속 계산기 사용 안내</h2>
            <p>환수 결속 시스템은 6마리 환수의 조합을 통해 다양한 능력치 시너지를 얻는 핵심 콘텐츠입니다. '바연화연'의 결속 계산기는 여러분이 보유한 환수들로 달성할 수 있는 최적의 조합을 찾아드립니다.</p>
            <p>이 계산기는 <strong>피해저항, 피해저항관통, 대인피해%*10, 대인방어%*10</strong>를 합산한 '환산 점수'를 기준으로 최적의 조합을 찾아내며, 유전 알고리즘을 통해 수많은 경우의 수를 빠르게 탐색합니다.</p>

            <h3>페이지 기능 설명</h3>
            <ul>
                <li><strong>카테고리 선택:</strong> '수호', '탑승', '변신' 탭을 클릭하여 해당 종류의 환수 목록을 확인하세요. 결속 조합은 동일 카테고리 내에서만 가능합니다.</li>
                <li><strong>환수 선택:</strong> 좌측 '전체 환수 목록'에서 결속 조합에 사용할 환수를 클릭하여 선택하세요. 선택된 환수는 우측 '선택된 환수' 목록에 추가됩니다. (레벨은 0으로 자동 설정됩니다.)</li>
                <li><strong>전체 선택/해제:</strong> '현재 탭 전체 선택' 또는 '현재 탭 전체 해제' 버튼을 사용하여 해당 카테고리의 모든 환수를 한 번에 선택하거나 해제할 수 있습니다.</li>
                <li><strong>환수 레벨 조절:</strong> 우측 선택된 환수 목록에서 각 환수의 레벨을 0~25 사이로 조절할 수 있습니다. '일괄 레벨 적용' 기능으로 모든 환수의 레벨을 한 번에 변경할 수도 있습니다.</li>
                <li><strong>최적 조합 찾기:</strong> '최적 조합 찾기' 버튼을 클릭하면 선택된 환수들 중 가장 높은 환산 점수를 내는 6마리 조합을 찾아 모달 창으로 표시합니다.</li>
                <li><strong>결과 모달 확인:</strong>
                    <ul>
                        <li><strong>조합 합산 점수:</strong> 모달 헤더에 '조합 합산: 1234 (123)' 형식으로 총점수(등록포함)와 결속점수를 함께 표시합니다. 등록 효과가 없을 경우 '조합 합산: 1234' 형식으로 표시됩니다.</li>
                        <li><strong>조합 저장 버튼:</strong> 헤더 우측에 위치한 '조합 저장' 버튼으로 현재 조합을 저장할 수 있습니다.</li>
                        <li><strong>현재 사용 중인 환수 선택:</strong> 결과 모달의 조합 환수 목록에서 현재 게임에서 사용 중인 환수를 클릭하면 등록 효과가 실시간으로 헤더 점수에 반영됩니다.</li>
                        <li><strong>레벨 조절 (장기 누르기):</strong> 각 환수의 +/- 버튼을 짧게 누르면 1레벨씩, 길게 누르면 연속으로 레벨이 변경됩니다. 모바일에서도 터치로 동일하게 작동하며, 조합 합산 점수가 실시간으로 업데이트됩니다.</li>
                        <li><strong>조합 환수:</strong> 선택된 6마리 환수의 목록을 보여주며, 각 환수의 레벨도 표시됩니다.</li>
                        <li><strong>효과별 스탯:</strong> 등급, 세력, 장착 효과로 인해 증가하는 능력치 목록과 합산 점수를 확인할 수 있습니다.</li>
                        <li><strong>상세 스탯 비교:</strong> 선택된 6마리 환수 각각의 상세 장착 스탯과 총합을 비교하여 볼 수 있습니다.</li>
                    </ul>
                </li>
                <li><strong>기록 탭:</strong> 이전에 계산했던 최적 조합 결과들을 기록 탭에서 다시 확인하고 비교할 수 있습니다. '최신', '최고' 점수를 쉽게 파악할 수 있습니다.</li>
            </ul>

            <h3>결속 시스템 팁 & 전략</h3>
            <ul>
                <li><strong>PvE와 PvP 조합:</strong> 보스 사냥을 위한 조합(피해저항관통, 보스몬스터추가피해)과 PvP를 위한 조합(대인방어%, 피해저해)은 스탯 우선순위가 다릅니다. 목표에 맞는 조합을 찾아보세요.</li>
                <li><strong>등급 시너지 vs 세력 시너지:</strong> 전설/불멸 환수 갯수에 따른 등급 시너지와 같은 세력 환수 갯수에 따른 세력 시너지을 모두 고려하는 것이 중요합니다. 때로는 낮은 등급이라도 세력 시너지를 맞추는 것이 더 유리할 수 있습니다.</li>
                <li><strong>실시간 레벨 조정:</strong> 결과 모달에서 각 환수의 레벨을 +/- 버튼으로 조정하면 조합 합산 점수가 실시간으로 변경됩니다. 장기 누르기로 빠르게 레벨을 변경할 수 있으며, 모바일에서도 터치로 동일하게 작동합니다.</li>
                <li><strong>고레벨 환수의 중요성:</strong> 장착 효과는 환수 레벨에 따라 크게 증가하므로, 주요 환수는 25레벨까지 육성하는 것이 중요합니다. 실시간 레벨 조정 기능으로 레벨별 점수 변화를 즉시 확인할 수 있습니다.</li>
                <li><strong>모든 환수 활용:</strong> 단순히 보유 환수 중 강한 환수 6마리를 고르는 것이 아니라, 결속 계산기를 통해 예상치 못한 조합이 더 좋은 결과를 낼 수도 있습니다.</li>
                <li><strong>등록 효과 활용:</strong> 결과 모달에서 현재 사용 중인 환수를 선택하여 등록 효과를 반영하면 실제 게임에서의 총 능력치를 정확히 파악할 수 있습니다. 헤더에 '조합 합산: 총점 (결속점)' 형식으로 표시됩니다.</li>
                <li><strong>빠른 조합 저장:</strong> 헤더 우측의 '조합 저장' 버튼으로 현재 조합을 기록 탭에 저장하여 나중에 비교할 수 있습니다.</li>
            </ul>
        </div>
    `}function He(){if(h.container){h.bondCategoryTabs&&p.bondCategoryTabsClickHandler&&h.bondCategoryTabs.removeEventListener("click",p.bondCategoryTabsClickHandler),h.container&&p.containerClickHandler&&h.container.removeEventListener("click",p.containerClickHandler),h.influenceToggle&&p.influenceToggleChangeHandler&&h.influenceToggle.removeEventListener("change",p.influenceToggleChangeHandler),h.selectedSpiritsList&&p.selectedSpiritsListInputHandler&&h.selectedSpiritsList.removeEventListener("input",p.selectedSpiritsListInputHandler),h.selectAllBtn&&p.selectAllClickHandler&&h.selectAllBtn.removeEventListener("click",p.selectAllClickHandler),h.clearAllSelectionBtn&&p.clearAllSelectionClickHandler&&h.clearAllSelectionBtn.removeEventListener("click",p.clearAllSelectionClickHandler),h.applyBatchLevelBtn&&p.applyBatchLevelClickHandler&&h.applyBatchLevelBtn.removeEventListener("click",p.applyBatchLevelClickHandler),h.findOptimalBtn&&p.findOptimalClickHandler&&h.findOptimalBtn.removeEventListener("click",p.findOptimalClickHandler);const n=document.getElementById("panelToggleBtn"),t=document.getElementById("selectedSpiritsMobile"),e=document.getElementById("applyMobileBatchLevelBtn"),l=document.getElementById("setMaxMobileBatchLevelBtn"),i=document.getElementById("findOptimalMobileBtn");n&&p.panelToggleBtnClickHandler&&n.removeEventListener("click",p.panelToggleBtnClickHandler),t&&p.mobileSelectedSpiritsListInputHandler&&t.removeEventListener("input",p.mobileSelectedSpiritsListInputHandler),e&&p.applyMobileBatchLevelClickHandler&&e.removeEventListener("click",p.applyMobileBatchLevelClickHandler),l&&p.setMaxMobileBatchLevelClickHandler&&l.removeEventListener("click",p.setMaxMobileBatchLevelClickHandler),i&&p.findOptimalMobileClickHandler&&i.removeEventListener("click",p.findOptimalMobileClickHandler);const a=document.getElementById("panelToggleContainer");a&&a.remove()}}const It=Object.freeze(Object.defineProperty({__proto__:null,cleanup:He,getHelpContentHTML:Ct,init:Et},Symbol.toStringTag,{value:"Module"}));export{It as b,Ge as s};
