import{p as t,S as L,e as x,M as D,v as N}from"./myInfo-common-BtkLlVFv.js";import{G as q,F as G,c as A}from"./components-K-_Tu490.js";function U(C){const $=["수호","탑승","변신"],E=[];$.forEach(o=>{const r=t.bondSpirits[o]||[],d={},v={};r.length>0&&C&&r.forEach(S=>{const a=C(o).find(l=>l.name===S.name);a&&(a.grade&&(d[a.grade]=(d[a.grade]||0)+1),a.influence&&(v[a.influence]=(v[a.influence]||0)+1))});const u=t.activeSpirits[o];if(u&&u.name&&C&&!r.some(a=>a.name===u.name)){const a=C(o).find(l=>l.name===u.name);a&&(a.grade&&(d[a.grade]=(d[a.grade]||0)+1),a.influence&&(v[a.influence]=(v[a.influence]||0)+1))}const f=Object.entries(d).sort(([S],[a])=>S.localeCompare(a)).map(([S,a])=>`${S}:${a}`).join(","),g=Object.entries(v).sort(([S],[a])=>S.localeCompare(a)).map(([S,a])=>`${S}:${a}`).join(",");if(r.length>0){const S=[...r].sort((a,l)=>{const e=(a.name||"").localeCompare(l.name||"");return e!==0?e:(a.level||25)-(l.level||25)});E.push(`${o}_bond:${S.map(a=>`${a.name}:${a.level||25}`).join(",")}|grades:${f}|factions:${g}`)}else(f||g)&&E.push(`${o}_bond:|grades:${f}|factions:${g}`)}),$.forEach(o=>{const r=t.activeSpirits[o];r&&E.push(`${o}_active:${r.name}:${r.level||25}`)}),$.forEach(o=>{const r=t.engravingData[o]||{};if(Object.keys(r).length>0){const d=Object.entries(r).sort(([u],[f])=>u.localeCompare(f)).reduce((u,[f,g])=>(u[f]=g,u),{}),v=JSON.stringify(d);E.push(`${o}_engraving:${v}`)}});const p=Object.entries(t.userStats).sort(([o],[r])=>o.localeCompare(r)).map(([o,r])=>`${o}:${r}`).join(",");E.push(`userStats:${p}`);const h=JSON.stringify(t.engravingData);return E.push(`engravingData:${h}`),E.join("|")}function I(C,$,E,p=!1,h){const o=M=>{const T=t.userStats[M]||0,P=$[M]||0;return Math.round(T+P)},r=o("damageResistancePenetration"),d=o("damageResistance"),v=o("pvpDamagePercent"),u=o("pvpDefensePercent"),f=Math.round(r+d+Math.round(Math.round(v)*10)+Math.round(Math.round(u)*10)),g=M=>t.baselineStats.hasOwnProperty(M)?t.baselineStats[M]:0,S=g("damageResistancePenetration"),a=g("damageResistance"),l=g("pvpDamagePercent"),e=g("pvpDefensePercent");let n=0;t.baselineKeyStats.tachaeTotal!==void 0&&t.baselineKeyStats.tachaeTotal!==null?n=t.baselineKeyStats.tachaeTotal:n=Math.round(S+a+Math.round(Math.round(l)*10)+Math.round(Math.round(e)*10));const s={},i=["수호","탑승","변신"];i.forEach(M=>{const T=t.activeSpirits[M];if(T&&T.name){const y=(t.engravingData[M]||{})[T.name]||{};Array.isArray(y.registration)&&y.registration.forEach(V=>{const b=V.statKey,m=V.value||0,O=typeof m=="number"?m:parseFloat(m)||0;O>0&&b&&(s[b]=(s[b]||0)+O)}),!y.registration&&!y.bind&&Object.keys(y).length>0&&Object.entries(y).forEach(([V,b])=>{let m=0;typeof b=="object"&&b!==null?m=b.registration||0:m=b||0;const O=typeof m=="number"?m:parseFloat(m)||0;O>0&&V&&(s[V]=(s[V]||0)+O)})}});const c={};if(i.forEach(M=>{(t.bondSpirits[M]||[]).forEach(P=>{const y=t.engravingData[M]?.[P.name]||{};y.bind&&Object.entries(y.bind).forEach(([V,b])=>{const m=typeof b=="number"?b:parseFloat(b)||0;m>0&&(c[V]=(c[V]||0)+m)}),!y.registration&&!y.bind&&Object.keys(y).length>0&&Object.entries(y).forEach(([V,b])=>{let m=0;typeof b=="object"&&b!==null?m=b.bind||0:m=b||0;const O=typeof m=="number"?m:parseFloat(m)||0;O>0&&(c[V]=(c[V]||0)+O)})})}),t.baselineKeyStats.tachaeTotal!==void 0&&t.baselineKeyStats.tachaeTotal!==null&&t.baselineKeyStats.tachaeTotal!==0&&Math.abs(f-n)>1e3){const M=Math.round(S+a+Math.round(Math.round(l)*10)+Math.round(Math.round(e)*10));Math.abs(M-f)<Math.abs(n-f)&&(n=M,t.baselineKeyStats.tachaeTotal=M)}const j=p?0:f-n,_=x.container?.querySelector("#keyStatTachae"),k=x.container?.querySelector("#keyStatTachaeChange"),R=x.container?.querySelector("#keyStatRegistrationList"),F=x.container?.querySelector("#keyStatBindList");if(_&&(_.textContent=Math.round(f).toLocaleString()),k&&(Math.abs(j)>.01?(k.textContent=j>0?`+${Math.round(j).toLocaleString()}`:`${Math.round(j).toLocaleString()}`,k.className=`my-info-key-stat-change ${j>0?"positive":"negative"}`,k.style.display="block"):(k.textContent="0",k.className="my-info-key-stat-change neutral",k.style.display="block")),R){R.innerHTML="";const M=Object.entries(s).sort((T,P)=>P[1]-T[1]);M.length===0?R.innerHTML='<div style="color: var(--text-secondary); font-size: 9px; padding: 4px;">등록효과 없음</div>':M.forEach(([T,P])=>{const y=L.find(H=>H.key===T)?.name||T,V=N()&&D[y]?D[y]:y,b=A("div","my-info-key-stat-registration-item"),m=A("span","my-info-key-stat-registration-item-name");m.textContent=V;const O=A("span","my-info-key-stat-registration-item-value");O.textContent=Math.round(P).toLocaleString(),b.appendChild(m),b.appendChild(O),R.appendChild(b)})}if(F){F.innerHTML="";const M=Object.entries(c).sort((T,P)=>P[1]-T[1]);M.length===0?F.innerHTML='<div style="color: var(--text-secondary); font-size: 9px; padding: 4px;">장착효과 없음</div>':M.forEach(([T,P])=>{const y=L.find(H=>H.key===T)?.name||T,V=N()&&D[y]?D[y]:y,b=A("div","my-info-key-stat-bind-item"),m=A("span","my-info-key-stat-bind-item-name");m.textContent=V;const O=A("span","my-info-key-stat-bind-item-value");O.textContent=Math.round(P).toLocaleString(),b.appendChild(m),b.appendChild(O),F.appendChild(b)})}}function w(C){const $=["수호","탑승","변신"],E={},p={},h={};for(const o of $){const r=t.bondSpirits[o]||[];if(r.length===0)continue;const d={},v={};for(const l of r){const e=C(o).find(n=>n.name===l.name);if(e){e.grade&&(d[e.grade]=(d[e.grade]||0)+1),e.influence&&(v[e.influence]=(v[e.influence]||0)+1);const n=l.level!==void 0&&l.level!==null?l.level:25,s=e.stats?.find(i=>i.level===n);s?.bindStat&&Object.entries(s.bindStat).forEach(([i,c])=>{const B=typeof c=="number"?c:parseFloat(c)||0,j=Math.round(B);E[i]=(E[i]||0)+j,h[i]=(h[i]||0)+j})}}const u=t.activeSpirits[o];if(u&&u.name&&!r.some(e=>e.name===u.name)){const e=C(o).find(n=>n.name===u.name);e&&(e.grade&&(d[e.grade]=(d[e.grade]||0)+1),e.influence&&(v[e.influence]=(v[e.influence]||0)+1))}const f=q[o],g={};f&&Object.entries(d).forEach(([l,e])=>{const n=f[l];if(!n)return;let s=0;for(let i=2;i<=e;i++)n[i.toString()]&&(s=i);if(s>0){const i=n[s.toString()];Object.entries(i).forEach(([c,B])=>{const j=Math.round(B);h[c]=(h[c]||0)+j,g[c]||(g[c]=0),g[c]+=j})}});const S={},a=G[o];if(a&&Object.entries(v).forEach(([l,e])=>{const n=a[l];if(!n)return;let s=0;for(let i=2;i<=e;i++)n[i.toString()]&&(s=i);if(s>0){const i=n[s.toString()];Object.entries(i).forEach(([c,B])=>{const j=Math.round(B);h[c]=(h[c]||0)+j,S[c]||(S[c]=0),S[c]+=j})}}),Object.keys(g).length>0||Object.keys(S).length>0,u){const l=C(o).find(e=>e.name===u.name);if(l){const e=l.stats?.find(n=>n.level===u.level);e?.registrationStat&&Object.entries(e.registrationStat).forEach(([n,s])=>{const i=typeof s=="number"?s:parseFloat(s)||0,c=Math.round(i);p[n]=(p[n]||0)+c,h[n]=(h[n]||0)+c})}}for(const l of r){const e=t.engravingData[o]?.[l.name]||{};e.bind&&Object.entries(e.bind).forEach(([n,s])=>{const i=typeof s=="number"?s:parseFloat(s)||0,c=Math.round(i);c>0&&(h[n]=(h[n]||0)+c)}),!e.registration&&!e.bind&&Object.keys(e).length>0&&Object.entries(e).forEach(([n,s])=>{let i=0;typeof s=="object"&&s!==null?i=s.bind||0:i=s||0;const c=typeof i=="number"?i:parseFloat(i)||0;c>0&&(h[n]=(h[n]||0)+c)})}if(u){const l=t.engravingData[o]?.[u.name]||{};Array.isArray(l.registration)&&l.registration.forEach(e=>{const n=e.statKey,s=e.value||0,i=typeof s=="number"?s:parseFloat(s)||0,c=Math.round(i);c>0&&n&&(h[n]=(h[n]||0)+c)}),!l.registration&&!l.bind&&Object.entries(l).forEach(([e,n])=>{let s=0;typeof n=="object"&&n!==null?s=n.registration||0:s=n||0,s>0&&(h[e]=(h[e]||0)+s)})}}return{allTotalStats:h,allBondStats:E,allActiveStats:p}}async function Z(C,$){if(t.isSavingBaseline||t.isUpdatingTotalStats)return Promise.resolve();t.isUpdatingTotalStats=!0;const E=U(C);if(t.lastTotalStatsHash===E&&t.lastTotalStatsCalculation){const p=t.lastTotalStatsCalculation;let h=t.isInitialLoad;if(t.baselineStatsHash)if(E===t.baselineStatsHash)h=!0;else{const o=[...L];let r=!0;for(const d of o){const v=t.userStats[d.key]||0,u=(p.allTotalStats||p.allBondStats)[d.key]||0,f=Math.round(v+u),g=t.baselineStats.hasOwnProperty(d.key)?t.baselineStats[d.key]:f;if(Math.abs(f-g)>.5){r=!1;break}}if(r){const d=f=>{const g=t.userStats[f]||0,S=(p.allTotalStats||p.allBondStats)[f]||0;return Math.round(g+S)},v=Math.round(d("damageResistancePenetration")+d("damageResistance")+Math.round(Math.round(d("pvpDamagePercent"))*10)+Math.round(Math.round(d("pvpDefensePercent"))*10)),u=t.baselineKeyStats.tachaeTotal||0;Math.abs(v-u)>.5&&(r=!1)}h=r}return $(p.allStats,p.allTotalStats||p.allBondStats,{},h),I(p.allStats,p.allTotalStats||p.allBondStats,{},h),t.isUpdatingTotalStats=!1,Promise.resolve()}try{const{allTotalStats:p,allBondStats:h,allActiveStats:o}=w(C);let r=t.isInitialLoad;if(t.baselineStatsHash)if(E===t.baselineStatsHash)r=!0;else{const v=[...L];let u=!0;for(const f of v){const g=t.userStats[f.key]||0,S=p[f.key]||0,a=Math.round(g+S),l=t.baselineStats.hasOwnProperty(f.key)?t.baselineStats[f.key]:a;if(Math.abs(a-l)>.5){u=!1;break}}if(u){const f=a=>{const l=t.userStats[a]||0,e=p[a]||0;return Math.round(l+e)},g=Math.round(f("damageResistancePenetration")+f("damageResistance")+Math.round(Math.round(f("pvpDamagePercent"))*10)+Math.round(Math.round(f("pvpDefensePercent"))*10)),S=t.baselineKeyStats.tachaeTotal||0;Math.abs(g-S)>.5&&(u=!1)}r=u}else r=t.isInitialLoad;const d=[...L];$(d,p,{},r),I(d,p,{},r,$),t.lastTotalStatsHash=E,t.lastTotalStatsCalculation={allStats:d,allBondStats:h,allActiveStats:o,allTotalStats:p}}catch{}finally{t.isUpdatingTotalStats=!1}}export{I as a,w as c,U as g,Z as u};
