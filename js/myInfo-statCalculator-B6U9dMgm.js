import{p as n,S as k,e as A,M as V,i as N}from"./myInfo-common-DGiNC5LG.js";import{c as x}from"./components-C2RsvHY9.js";import{L as q}from"./utils-x5ORUUhl.js";function U(){const T=["수호","탑승","변신"],b=[];T.forEach(o=>{const l=n.bondSpirits[o]||[];l.length>0&&b.push(`${o}_bond:${l.map(u=>`${u.name}:${u.level||25}`).join(",")}`)}),T.forEach(o=>{const l=n.activeSpirits[o];l&&b.push(`${o}_active:${l.name}:${l.level||25}`)}),T.forEach(o=>{const l=n.engravingData[o]||{};if(Object.keys(l).length>0){const u=Object.entries(l).sort(([i],[y])=>i.localeCompare(y)).map(([i,y])=>{const L=Object.entries(y).sort(([P],[d])=>P.localeCompare(d)).map(([P,d])=>`${P}:${d}`).join(",");return`${i}:{${L}}`}).join("|");b.push(`${o}_engraving:${u}`)}});const O=Object.entries(n.userStats).sort(([o],[l])=>o.localeCompare(l)).map(([o,l])=>`${o}:${l}`).join(",");return b.push(`userStats:${O}`),b.join("|")}function B(T,b,O,o=!1,l){const u=c=>{const g=n.userStats[c]||0,v=b[c]||0;return Math.round(g+v)},i=u("damageResistancePenetration"),y=u("damageResistance"),L=u("pvpDamagePercent"),P=u("pvpDefensePercent"),d=Math.round(i+y+Math.round(Math.round(L)*10)+Math.round(Math.round(P)*10)),S=c=>n.baselineStats.hasOwnProperty(c)?n.baselineStats[c]:0,M=S("damageResistancePenetration"),C=S("damageResistance"),j=S("pvpDamagePercent"),$=S("pvpDefensePercent");let f=0;n.baselineKeyStats.tachaeTotal!==void 0&&n.baselineKeyStats.tachaeTotal!==null?f=n.baselineKeyStats.tachaeTotal:f=Math.round(M+C+Math.round(Math.round(j)*10)+Math.round(Math.round($)*10));const r={},s=["수호","탑승","변신"];s.forEach(c=>{const g=n.activeSpirits[c];if(g){const v=n.engravingData[c]?.[g.name]||{};Array.isArray(v.registration)&&v.registration.forEach(h=>{const E=h.statKey,m=h.value||0,R=typeof m=="number"?m:parseFloat(m)||0;R>0&&E&&(r[E]=(r[E]||0)+R)})}});const t={};if(s.forEach(c=>{(n.bondSpirits[c]||[]).forEach(v=>{const h=n.engravingData[c]?.[v.name]||{};h.bind&&Object.entries(h.bind).forEach(([E,m])=>{const R=typeof m=="number"?m:parseFloat(m)||0;R>0&&(t[E]=(t[E]||0)+R)})})}),Math.abs(d-f)>1e3){console.error("[환산타채 합 계산] 이상값 감지:",{tachaeTotal:d,baselineTachaeTotal:f,change:d-f,damageResistancePenetration:i,damageResistance:y,pvpDamagePercent:L,pvpDefensePercent:P,baselineDamageResistancePenetration:M,baselineDamageResistance:C,baselinePvpDamagePercent:j,baselinePvpDefensePercent:$,savedTachaeTotal:n.baselineKeyStats.tachaeTotal,baselineStats_pvpDamagePercent:n.baselineStats.pvpDamagePercent,baselineStats_pvpDefensePercent:n.baselineStats.pvpDefensePercent});const c=Math.round(M+C+Math.round(Math.round(j)*10)+Math.round(Math.round($)*10));Math.abs(c-d)<Math.abs(f-d)&&(console.warn("[환산타채 합 계산] 기준값 재계산:",{old:f,new:c}),f=c,n.baselineKeyStats.tachaeTotal=c)}const e=o?0:d-f,a=A.container?.querySelector("#keyStatTachae"),p=A.container?.querySelector("#keyStatTachaeChange"),D=A.container?.querySelector("#keyStatRegistrationList"),_=A.container?.querySelector("#keyStatBindList");if(a&&(a.textContent=Math.round(d).toLocaleString()),p&&(Math.abs(e)>.01?(p.textContent=e>0?`+${Math.round(e).toLocaleString()}`:`${Math.round(e).toLocaleString()}`,p.className=`my-info-key-stat-change ${e>0?"positive":"negative"}`,p.style.display="block"):(p.textContent="0",p.className="my-info-key-stat-change neutral",p.style.display="block")),D){D.innerHTML="";const c=Object.entries(r).sort((g,v)=>v[1]-g[1]);c.length===0?D.innerHTML='<div style="color: var(--text-secondary); font-size: 9px; padding: 4px;">등록효과 없음</div>':c.forEach(([g,v])=>{const h=k.find(H=>H.key===g)?.name||g,E=N()&&V[h]?V[h]:h,m=x("div","my-info-key-stat-registration-item"),R=x("span","my-info-key-stat-registration-item-name");R.textContent=E;const F=x("span","my-info-key-stat-registration-item-value");F.textContent=Math.round(v).toLocaleString(),m.appendChild(R),m.appendChild(F),D.appendChild(m)})}if(_){_.innerHTML="";const c=Object.entries(t).sort((g,v)=>v[1]-g[1]);c.length===0?_.innerHTML='<div style="color: var(--text-secondary); font-size: 9px; padding: 4px;">장착효과 없음</div>':c.forEach(([g,v])=>{const h=k.find(H=>H.key===g)?.name||g,E=N()&&V[h]?V[h]:h,m=x("div","my-info-key-stat-bind-item"),R=x("span","my-info-key-stat-bind-item-name");R.textContent=E;const F=x("span","my-info-key-stat-bind-item-value");F.textContent=Math.round(v).toLocaleString(),m.appendChild(R),m.appendChild(F),_.appendChild(m)})}}async function z(T,b){if(n.isSavingBaseline||n.isUpdatingTotalStats)return Promise.resolve();n.isUpdatingTotalStats=!0;const O=U();if(n.lastTotalStatsHash===O&&n.lastTotalStatsCalculation){const o=n.lastTotalStatsCalculation,l=n.isInitialLoad;return b(o.allStats,o.allTotalStats||o.allBondStats,{},l),B(o.allStats,o.allTotalStats||o.allBondStats,{},l),n.isUpdatingTotalStats=!1,Promise.resolve()}try{const o=["수호","탑승","변신"],l={},u={},i={},y={수호:{전설:{2:{damageResistance:100,pvpDefensePercent:1},3:{damageResistance:200,pvpDefensePercent:2},4:{damageResistance:350,pvpDefensePercent:3.5},5:{damageResistance:550,pvpDefensePercent:5.5}},불멸:{2:{damageResistance:150,pvpDefensePercent:1.5},3:{damageResistance:300,pvpDefensePercent:3},4:{damageResistance:525,pvpDefensePercent:5.25},5:{damageResistance:825,pvpDefensePercent:8.25}}},탑승:{전설:{2:{damageResistancePenetration:100,pvpDamagePercent:1},3:{damageResistancePenetration:200,pvpDamagePercent:2},4:{damageResistancePenetration:350,pvpDamagePercent:3.5},5:{damageResistancePenetration:550,pvpDamagePercent:5.5}},불멸:{2:{damageResistancePenetration:150,pvpDamagePercent:1.5},3:{damageResistancePenetration:300,pvpDamagePercent:3},4:{damageResistancePenetration:525,pvpDamagePercent:5.25},5:{damageResistancePenetration:825,pvpDamagePercent:8.25}}},변신:{전설:{2:{damageResistance:50,damageResistancePenetration:50,pvpDefensePercent:.5,pvpDamagePercent:.5},3:{damageResistance:100,damageResistancePenetration:100,pvpDefensePercent:1,pvpDamagePercent:1},4:{damageResistance:175,damageResistancePenetration:175,pvpDefensePercent:1.75,pvpDamagePercent:1.75},5:{damageResistance:275,damageResistancePenetration:275,pvpDefensePercent:2.75,pvpDamagePercent:2.75}},불멸:{2:{damageResistance:75,damageResistancePenetration:75,pvpDefensePercent:.75,pvpDamagePercent:.75},3:{damageResistance:150,damageResistancePenetration:150,pvpDefensePercent:1.5,pvpDamagePercent:1.5},4:{damageResistance:262,damageResistancePenetration:262,pvpDefensePercent:2.62,pvpDamagePercent:2.62},5:{damageResistance:412,damageResistancePenetration:412,pvpDefensePercent:4.12,pvpDamagePercent:4.12}}}},L={결의:{2:{damageResistance:200},3:{damageResistance:400},4:{damageResistance:600},5:{damageResistance:800}},고요:{2:{damageResistancePenetration:200},3:{damageResistancePenetration:400},4:{damageResistancePenetration:600},5:{damageResistancePenetration:800}},의지:{2:{pvpDamagePercent:2},3:{pvpDamagePercent:4},4:{pvpDamagePercent:6},5:{pvpDamagePercent:8}},침착:{2:{pvpDefensePercent:2},3:{pvpDefensePercent:4},4:{pvpDefensePercent:6},5:{pvpDefensePercent:8}},냉정:{2:{damageResistance:100,damageResistancePenetration:100},3:{damageResistance:200,damageResistancePenetration:200},4:{damageResistance:300,damageResistancePenetration:300},5:{damageResistance:400,damageResistancePenetration:400}},활력:{2:{pvpDamagePercent:1,pvpDefensePercent:1},3:{pvpDamagePercent:2,pvpDefensePercent:2},4:{pvpDamagePercent:3,pvpDefensePercent:3},5:{pvpDamagePercent:4,pvpDefensePercent:4}}};for(const S of o){const M=n.bondSpirits[S]||[];if(M.length===0)continue;const C={},j={};for(const r of M){const s=T(S).find(t=>t.name===r.name);if(s){s.grade&&(C[s.grade]=(C[s.grade]||0)+1),s.influence&&(j[s.influence]=(j[s.influence]||0)+1);const t=r.level!==void 0&&r.level!==null?r.level:25,e=s.stats?.find(a=>a.level===t);e?.bindStat&&Object.entries(e.bindStat).forEach(([a,p])=>{const D=typeof p=="number"?p:parseFloat(p)||0;l[a]=(l[a]||0)+D,i[a]=(i[a]||0)+D})}}const $=y[S];$&&Object.entries(C).forEach(([r,s])=>{const t=$[r];if(!t)return;let e=0;for(let a=2;a<=s;a++)t[a.toString()]&&(e=a);if(e>0){const a=t[e.toString()];Object.entries(a).forEach(([p,D])=>{i[p]=(i[p]||0)+D})}}),Object.entries(j).forEach(([r,s])=>{const t=L[r];if(!t)return;let e=0;for(let a=2;a<=s;a++)t[a.toString()]&&(e=a);if(e>0){const a=t[e.toString()];Object.entries(a).forEach(([p,D])=>{i[p]=(i[p]||0)+D})}});const f=n.activeSpirits[S];if(f){const r=T(S).find(s=>s.name===f.name);if(r){const s=r.stats?.find(t=>t.level===f.level);s?.registrationStat&&Object.entries(s.registrationStat).forEach(([t,e])=>{const a=typeof e=="number"?e:parseFloat(e)||0;u[t]=(u[t]||0)+a,i[t]=(i[t]||0)+a})}}for(const r of M){const s=n.engravingData[S]?.[r.name]||{};s.bind&&Object.entries(s.bind).forEach(([t,e])=>{const a=typeof e=="number"?e:parseFloat(e)||0;a>0&&(i[t]=(i[t]||0)+a)}),!s.registration&&!s.bind&&Object.entries(s).forEach(([t,e])=>{let a=0;typeof e=="object"&&e!==null?a=e.bind||0:a=e||0,a>0&&(i[t]=(i[t]||0)+a)})}if(f){const r=n.engravingData[S]?.[f.name]||{};Array.isArray(r.registration)&&r.registration.forEach(s=>{const t=s.statKey,e=s.value||0,a=typeof e=="number"?e:parseFloat(e)||0;a>0&&t&&(i[t]=(i[t]||0)+a)}),!r.registration&&!r.bind&&Object.entries(r).forEach(([s,t])=>{let e=0;typeof t=="object"&&t!==null?e=t.registration||0:e=t||0,e>0&&(i[s]=(i[s]||0)+e)})}}let P=n.isInitialLoad;n.baselineStatsHash?O===n.baselineStatsHash?P=!0:P=!1:P=n.isInitialLoad;const d=[...k];b(d,i,{},P),B(d,i,{},P,b),n.lastTotalStatsHash=O,n.lastTotalStatsCalculation={allStats:d,allBondStats:l,allActiveStats:u,allTotalStats:i}}catch(o){q.error("Error updating total stats:",o)}finally{n.isUpdatingTotalStats=!1}}export{z as a,U as g,B as u};
